<div class="receptionist-layout">
  <app-header></app-header>
  <div class="body">
    <app-sidebar [title]="'QuickMed'" [menuItems]="menuItems" [secondaryItems]="secondaryItems"></app-sidebar>

    <main class="panel">
      <section class="hero">
        <div>
          <p class="eyebrow">Doctor coordination</p>
          <h1>Doctor Availability</h1>
          <p class="muted">Match patients to live availability and keep schedules aligned.</p>
        </div>
        <div class="hero-actions">
          <div class="search-input-wrapper">
            <i class="bi bi-search"></i>
            <input type="text" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
              placeholder="Search doctor or specialty..." />
          </div>
          <label>
            <span>Date</span>
            <input type="date" [ngModel]="dateFilter()" (ngModelChange)="dateFilter.set($event); loadAvailability()" />
          </label>
          <button class="ghost" type="button" (click)="loadAvailability()">
            <i class="bi bi-arrow-clockwise"></i>
            Refresh
          </button>
        </div>

      </section>

      <section class="cards" *ngIf="filteredDoctors().length; else empty">
        <article class="doc-card" *ngFor="let doc of filteredDoctors()">
          <div class="doc-main">
            <div class="doc-info-group">
              <div class="doc-header">
                <div class="avatar">
                  <img *ngIf="doc.avatar" [src]="doc.avatar" alt="" />
                  <span *ngIf="!doc.avatar">{{ doc.name.charAt(0) }}</span>
                </div>
                <div>
                  <h3>{{ doc.name }}</h3>
                  <p class="muted">{{ doc.specialty || 'General' }}</p>
                </div>
              </div>

              <div class="stats-grid">
                <div class="stat-item available">
                  <span class="label">Available</span>
                  <span class="value">{{ doc.availability?.available }}</span>
                </div>
                <div class="stat-item booked">
                  <span class="label">Booked</span>
                  <span class="value">{{ doc.availability?.booked }}</span>
                </div>
                <div class="stat-item blocked">
                  <span class="label">Blocked</span>
                  <span class="value">{{ doc.availability?.blocked }}</span>
                </div>
              </div>

              <div class="actions">
                <button class="btn-primary-sm" (click)="bookSlot(doc, null)">
                  <i class="bi bi-calendar-plus"></i>
                  Book Appointment
                </button>
                <button class="btn-secondary-sm" (click)="addCustomSlot(doc)">
                  <i class="bi bi-plus-circle"></i>
                  Add Slot
                </button>
              </div>
            </div>

            <div class="availability-timeline">
              <div class="shift-wrapper" *ngFor="let shift of [
                { id: 'morning', label: 'Morning', icon: 'bi-brightness-high', slots: doc.groupedSlots.morning, data: doc.availability?.shifts?.morning },
                { id: 'afternoon', label: 'Afternoon', icon: 'bi-sun', slots: doc.groupedSlots.afternoon, data: doc.availability?.shifts?.afternoon },
                { id: 'evening', label: 'Evening', icon: 'bi-moon-stars', slots: doc.groupedSlots.evening, data: doc.availability?.shifts?.evening }
              ]">
                <div class="shift-header">
                  <div class="shift-meta">
                    <i [class]="shift.icon"></i>
                    <span class="shift-label">{{ shift.label }}</span>
                    <span class="shift-status" [class.active]="shift.data?.enabled">{{ shift.data?.enabled ? 'Active' :
                      'Offline' }}</span>
                  </div>
                  <div class="shift-controls">
                    <span class="available-count" *ngIf="shift.data?.enabled">{{ getAvailableCount(shift.slots) }}
                      available</span>
                    <button class="mini-toggle" (click)="toggleShift(doc, shift.id)">
                      <i class="bi" [class.bi-toggle-on]="shift.data?.enabled"
                        [class.bi-toggle-off]="!shift.data?.enabled"></i>
                    </button>
                  </div>
                </div>

                <!-- NEW: Amazing Availability Bar -->
                <div class="availability-bar" *ngIf="shift.data?.enabled && shift.slots.length; else disabledState">
                  <div class="bar-segments">
                    <div *ngFor="let slot of shift.slots" class="segment" [class.booked]="slot.status === 'booked'"
                      [class.blocked]="slot.status === 'blocked'" [class.available]="slot.status === 'available'"
                      (click)="bookSlot(doc, slot)" [attr.data-time]="slot.startTime || slot.time">
                      <div class="segment-tooltip">{{ slot.startTime || slot.time }} - {{ slot.status }}</div>
                    </div>
                  </div>
                </div>

                <ng-template #disabledState>
                  <div class="shift-disabled-message">
                    {{ shift.data?.enabled ? 'No slots scheduled for this period.' : 'Shift is currently disabled.' }}
                  </div>
                </ng-template>

                <!-- Quick Action for the nearest slot -->
                <div class="next-action" *ngIf="shift.data?.enabled && getFirstAvailable(shift.slots) as first">
                  <p>Next: <span>{{ first.startTime || first.time }}</span></p>
                  <button (click)="bookSlot(doc, first)">Quick Book</button>
                </div>
              </div>

              <!-- Status Legend -->
              <div class="status-legend" *ngIf="doc.availability?.slots?.length">
                <div class="legend-item"><span class="dot available"></span> Available</div>
                <div class="legend-item"><span class="dot booked"></span> Booked</div>
                <div class="legend-item"><span class="dot blocked"></span> Blocked</div>
              </div>
            </div>


          </div>
        </article>
      </section>

      <ng-template #empty>
        <div class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-calendar2-week"></i>
          </div>
          <div>
            <h3>No availability for this date</h3>
            <p class="muted">Ask a doctor to publish their schedule or choose another day.</p>
          </div>
        </div>
      </ng-template>
    </main>
  </div>

  <!-- Add Slot Modal -->
  <div class="modal-overlay" *ngIf="showAddSlotModal()" (click)="closeAddSlotModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Custom Slot</h2>
        <button class="close-btn" (click)="closeAddSlotModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-subtitle">Add a one-off availability slot for <strong>{{ selectedDoctor()?.name }}</strong>.</p>

        <div class="form-group">
          <label>Date</label>
          <div class="input-wrapper">
            <i class="bi bi-calendar"></i>
            <input type="date" [ngModel]="newSlotDate()" (ngModelChange)="newSlotDate.set($event)">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Start Time</label>
            <div class="input-wrapper">
              <i class="bi bi-clock"></i>
              <input type="time" [ngModel]="newSlotStartTime()" (ngModelChange)="newSlotStartTime.set($event)">
            </div>
          </div>

          <div class="form-group">
            <label>End Time</label>
            <div class="input-wrapper">
              <i class="bi bi-clock-history"></i>
              <input type="time" [ngModel]="newSlotEndTime()" (ngModelChange)="newSlotEndTime.set($event)">
            </div>
          </div>
        </div>

        <div class="info-box" *ngIf="newSlotStartTime() && newSlotEndTime()">
          <i class="bi bi-info-circle"></i>
          <span>New slot will be created from <strong>{{ newSlotStartTime() }}</strong> to <strong>{{ newSlotEndTime()
              }}</strong>.</span>
        </div>

        <div class="error-box" *ngIf="errorMessage()">
          <i class="bi bi-exclamation-triangle"></i>
          <span>{{ errorMessage() }}</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="ghost" (click)="closeAddSlotModal()">Cancel</button>
        <button class="btn-primary-sm" (click)="confirmAddSlot()"
          [disabled]="!newSlotDate() || !newSlotStartTime() || !newSlotEndTime()">
          <i class="bi bi-plus-lg"></i>
          Add Slot
        </button>
      </div>
    </div>
  </div>
</div>