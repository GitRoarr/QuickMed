<div class="doctor-schedule" [class.dark]="themeMode()==='dark'">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <img src="assets/images/QuickMed-Logo.png" alt="QuickMed Logo" class="h-8 w-8 rounded" />
        </div>
        <div class="logo-text">
          <h3>QuickMed</h3>
          <p>Doctor Portal</p>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a
        *ngFor="let item of menuItems()"
        [routerLink]="item.route"
        routerLinkActive="active"
        class="nav-item"
      >
        <i [class]="'bi ' + item.icon"></i>
        <span>{{ item.label }}</span>
        <span *ngIf="item.badge && item.badge > 0" class="badge">{{ item.badge }}</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">
          <img *ngIf="currentUser()?.avatar; else docInitials" [src]="currentUser()?.avatar" alt="Doctor avatar" />
          <ng-template #docInitials>{{ getDoctorInitials() }}</ng-template>
        </div>
        <div class="user-details">
          <p class="user-name">Dr. {{ getDoctorName() }}</p>
          <p class="user-role">{{ getDoctorSpecialty() }}</p>
        </div>
      </div>
      <button class="logout-btn" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i>
        Logout
      </button>
    </div>
  </aside>

  <main class="main-content">
    <div class="topbar">
     
      <div class="topbar-actions">
        
        <div class="divider"></div>
        <button class="icon-btn" [routerLink]="'/doctor/messages'" title="Messages">
          <i class="bi bi-chat-dots"></i>
          <span class="badge-dot" *ngIf="unreadMessages() > 0">{{ unreadMessages() > 99 ? '99+' : unreadMessages() }}</span>
        </button>
        <button class="icon-btn" [routerLink]="'/doctor/notifications'" title="Notifications">
          <i class="bi bi-bell"></i>
          <span class="badge-dot" *ngIf="unreadNotifications() > 0">{{ unreadNotifications() > 99 ? '99+' : unreadNotifications() }}</span>
        </button>
        <div class="divider"></div>
        <button class="pill-toggle" type="button" title="Light mode" [class.active]="themeMode()==='light'" (click)="setTheme('light')"><i class="bi bi-brightness-high"></i></button>
        <button class="pill-toggle" type="button" title="Dark mode" [class.active]="themeMode()==='dark'" (click)="setTheme('dark')"><i class="bi bi-moon"></i></button>
        <div class="avatar-sm">
          <img *ngIf="currentUser()?.avatar; else docSmall" [src]="currentUser()?.avatar" alt="Doctor" />
          <ng-template #docSmall>{{ getDoctorInitials() }}</ng-template>
        </div>
      </div>
    </div>

    <header class="content-header">
      <div>
        <h1 class="page-title">Schedule</h1>
        <p class="page-subtitle">Manage availability, view appointments, and act quickly.</p>
      </div>
      <div class="header-actions">
        <div class="view-toggle">
          <button [class.active]="viewMode()==='day'" (click)="setViewMode('day')">Day</button>
          <button [class.active]="viewMode()==='week'" (click)="setViewMode('week')">Week</button>
          <button [class.active]="viewMode()==='month'" (click)="setViewMode('month')">Month</button>
        </div>
        <div class="slot-config">
          <label>Slot</label>
          <select [ngModel]="slotDurationMinutes()" (ngModelChange)="slotDurationMinutes.set(+($event))" [ngModelOptions]="{standalone:true}">
            <option [ngValue]="15">15m</option>
            <option [ngValue]="20">20m</option>
            <option [ngValue]="30">30m</option>
            <option [ngValue]="45">45m</option>
            <option [ngValue]="60">60m</option>
          </select>
        </div>
      </div>
    </header>

    <div class="top-panels">
      <div class="calendar-card">
        <div class="calendar-header">
          <button class="nav-btn" (click)="previousMonth()"><i class="bi bi-chevron-left"></i></button>
          <h2 class="month-year">{{ getMonthYear() }}</h2>
          <button class="nav-btn" (click)="nextMonth()"><i class="bi bi-chevron-right"></i></button>
        </div>
        <div class="calendar-grid">
          <div class="calendar-weekdays">
            <div class="weekday" *ngFor="let day of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">{{ day }}</div>
          </div>
          <div class="calendar-days">
            <button
              *ngFor="let date of getCalendarDays()"
              class="calendar-day"
              [class.today]="isToday(date)"
              [class.selected]="isSelected(date)"
              [class.other-month]="!isCurrentMonth(date)"
              (click)="selectDate(date)"
            >
              {{ date.getDate() }}
            </button>
          </div>
        </div>

        <div class="availability-toggle">
          <div class="day-buttons">
            <button *ngFor="let d of [0,1,2,3,4,5,6]"
              [class.active]="workingDays().includes(d)"
              (click)="toggleWorkingDay(d)">
              {{ ['S','M','T','W','T','F','S'][d] }}
            </button>
          </div>
          <div class="hours-row">
            <label>Hours</label>
            <input type="time" [ngModel]="workingStart()" (ngModelChange)="workingStart.set($event)" [ngModelOptions]="{standalone:true}">
            <span>–</span>
            <input type="time" [ngModel]="workingEnd()" (ngModelChange)="workingEnd.set($event)" [ngModelOptions]="{standalone:true}">
          </div>
          <div class="hours-row">
            <label>
              Break
              <span class="muted" style="margin-left:8px; font-size:12px;">
                <input type="checkbox" [ngModel]="hasBreak()" (ngModelChange)="hasBreak.set($event)" [ngModelOptions]="{standalone:true}">
                Enable (optional)
              </span>
            </label>
            <input type="time" [disabled]="!hasBreak()" [ngModel]="breakStart()" (ngModelChange)="breakStart.set($event)" [ngModelOptions]="{standalone:true}">
            <span>–</span>
            <input type="time" [disabled]="!hasBreak()" [ngModel]="breakEnd()" (ngModelChange)="breakEnd.set($event)" [ngModelOptions]="{standalone:true}">
            <button class="primary ghost" (click)="saveAvailability()">Save</button>
          </div>
        </div>

      </div>

      <div class="today-card">
        <div class="today-head">
          <div>
            <p class="eyebrow">Today</p>
            <h3>{{ today | date:'EEEE, MMM d' }}</h3>
          </div>
          <span class="chip">{{ getSelectedDateAppointments().length }} appts</span>
        </div>
        <div class="next" *ngIf="nextAppointment(); else noNext">
          <p class="label">Next patient</p>
          <h4>{{ nextAppointment()?.patient?.firstName }} {{ nextAppointment()?.patient?.lastName }}</h4>
          <p class="time">{{ formatTime12(nextAppointment()?.appointmentTime) }} • {{ nextAppointment()?.isVideoConsultation ? 'Online' : 'In-person' }}</p>
          <div class="next-actions">
            <button class="primary" *ngIf="nextAppointment()?.isVideoConsultation" (click)="joinCall(nextAppointment()!)">Join call</button>
            <button class="ghost" (click)="openNextAppointmentDay()">Open day</button>
          </div>
        </div>
        <ng-template #noNext>
          <p class="muted">No upcoming appointments today.</p>
        </ng-template>
      </div>
    </div>

    <section class="schedule-board">
      <header class="board-head">
        <div>
          <h3>{{ selectedDate() | date:'MMMM d, yyyy' }}</h3>
          <p class="muted" *ngIf="!hasBlockedSlots()">Slots generated automatically from your availability. Accept, reject, or reschedule quickly.</p>
        </div>
        <div class="quick-filters">
          <span class="chip">Day view</span>
          <span class="chip muted">{{ slotDurationMinutes() }}m slots</span>
        </div>
      </header>

      <div class="board-scroll">
      <ng-container [ngSwitch]="viewMode()">
        <div *ngSwitchCase="'day'">
          <div *ngIf="visibleDaySlots().length; else emptyState" class="timeline">
            <div class="slot-row" *ngFor="let slot of visibleDaySlots()">
              <div class="slot-time">{{ formatRange12(slot.startTime, slot.endTime) }}</div>
              <div class="slot-card" [ngClass]="[slot.status, getAppointmentForSlot(slot)?.isVideoConsultation ? 'online' : '']">
                <ng-container *ngIf="getAppointmentForSlot(slot) as appt; else available">
                  <div class="slot-meta">
                    <div class="patient">{{ appt.patient?.firstName }} {{ appt.patient?.lastName }}</div>
                    <div class="type">{{ appt.isVideoConsultation ? 'Online' : 'In-person' }} • {{ appt.appointmentType || 'Consultation' }}</div>
                  </div>
                  <div class="actions">
                    <button class="ghost" (click)="rescheduleAppointment(appt)"><i class="bi bi-arrow-repeat"></i> Reschedule</button>
                    <button class="ghost" (click)="acceptAppointment(appt)" *ngIf="appt.status === 'pending'"><i class="bi bi-check2"></i> Accept</button>
                    <button class="ghost danger" (click)="rejectAppointment(appt)"><i class="bi bi-x"></i> Cancel</button>
                    <button class="ghost" (click)="completeAppointment(appt)"><i class="bi bi-flag"></i> Mark done</button>
                    <button class="primary" *ngIf="appt.isVideoConsultation" (click)="joinCall(appt)"><i class="bi bi-camera-video"></i> Join</button>
                  </div>
                </ng-container>
                <ng-template #available>
                  <div class="slot-meta available-row">
                    <div>
                      <div class="patient">Available</div>
                      <div class="type">{{ isPastSlot(slot) ? 'Past time' : (slot.status === 'blocked' ? 'Blocked' : 'Open for booking') }}</div>
                    </div>
                    <div class="actions">
                      <button class="ghost" *ngIf="slot.status === 'blocked'" (click)="setAvailableSlot(slot)" [disabled]="isPastSlot(slot)">Set available</button>
                      <button class="ghost danger" *ngIf="slot.status !== 'blocked'" (click)="blockSlot(slot)" [disabled]="isPastSlot(slot)">Block</button>
                    </div>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <div *ngSwitchCase="'week'" class="week-grid">
          <div class="week-day" *ngFor="let d of weekDays()">
            <div class="week-day-head">
              <strong>{{ d | date:'EEE' }}</strong>
              <span>{{ d | date:'MMM d' }}</span>
            </div>
            <div class="week-count">{{ countAppointmentsForDate(d) }} appts</div>
          </div>
        </div>

        <div *ngSwitchCase="'month'" class="empty">
          <p>Use the calendar to navigate the month. Select any day to drill into slots.</p>
        </div>
      </ng-container>

      <ng-template #emptyState>
        <div class="empty">
          <p *ngIf="noVisibleButHasSlots(); else noSlots">All slots for this day are either blocked or in the past. Adjust hours or generate new slots.</p>
          <ng-template #noSlots>
            <p>No slots yet for this day. Adjust working hours or click Save to generate slots.</p>
          </ng-template>
          <button class="primary" (click)="saveAvailability()">Generate slots</button>
        </div>
      </ng-template>
      </div>
    </section>
  </main>
</div>
