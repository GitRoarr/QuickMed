<div class="analytics-container flex flex-col h-full overflow-hidden">
  <!-- Shared Header -->
  <app-doctor-header [initials]="getDoctorInitials()" [avatarUrl]="currentUser()?.avatar"
    [unreadNotifications]="unreadNotificationCount()"></app-doctor-header>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 lg:p-10">
    <div class="max-w-[1600px] mx-auto space-y-10 fade-in-up">

      <!-- Page Header -->
      <div class="flex flex-col xl:flex-row xl:items-end justify-between gap-6">
        <div>
          <h1 class="analytics-title">Analytics & Insights</h1>
          <p class="subtitle">Track your practice performance with real-time metrics and trends</p>
        </div>

        <!-- Period Selector -->
        <div class="period-selector">
          <button *ngFor="let period of periodOptions" (click)="onPeriodChange(period.value)" class="period-btn"
            [class.active]="selectedPeriod() === period.value">
            {{ period.label }}
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading()" class="loading-container">
        <div class="loading-spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-active"></div>
        </div>
        <p class="loading-text">Gathering insights...</p>
      </div>

      <!-- Content Grid -->
      <div *ngIf="!isLoading() && analytics()" class="space-y-8" [@fadeInUp]>

        <!-- KPI Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">

          <!-- Revenue -->
          <div class="kpi-card group">
            <div class="flex justify-between items-start mb-6">
              <div class="kpi-icon-wrapper icon-emerald">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <span class="kpi-badge badge-positive flex items-center gap-1">
                <i class="bi bi-graph-up-arrow text-xs"></i> +12.5%
              </span>
            </div>
            <div>
              <p class="kpi-label">Total Revenue</p>
              <h3 class="kpi-value">${{ analytics()!.kpis.revenue | number:'1.0-0' }}</h3>
            </div>
          </div>

          <!-- Appointments -->
          <div class="kpi-card group">
            <div class="flex justify-between items-start mb-6">
              <div class="kpi-icon-wrapper icon-blue">
                <i class="bi bi-calendar-check"></i>
              </div>
              <span class="kpi-badge"
                [ngClass]="analytics()!.trends.appointmentsChange >= 0 ? 'badge-positive' : 'badge-negative'">
                <i class="bi"
                  [ngClass]="analytics()!.trends.appointmentsChange >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short'"></i>
                {{ analytics()!.trends.appointmentsChange }}%
              </span>
            </div>
            <div>
              <p class="kpi-label">Appointments</p>
              <h3 class="kpi-value">{{ analytics()!.kpis.totalAppointments }}</h3>
            </div>
          </div>

          <!-- Completion Rate -->
          <div class="kpi-card group">
            <div class="flex justify-between items-start mb-6">
              <div class="kpi-icon-wrapper icon-violet">
                <i class="bi bi-pie-chart"></i>
              </div>
              <span class="kpi-badge"
                [ngClass]="analytics()!.trends.completionChange >= 0 ? 'badge-positive' : 'badge-negative'">
                <i class="bi"
                  [ngClass]="analytics()!.trends.completionChange >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short'"></i>
                {{ analytics()!.trends.completionChange }}%
              </span>
            </div>
            <div>
              <p class="kpi-label">Completion Rate</p>
              <h3 class="kpi-value">{{ analytics()!.kpis.completionRate }}%</h3>
            </div>
          </div>

          <!-- Satisfaction -->
          <div class="kpi-card group">
            <div class="flex justify-between items-start mb-6">
              <div class="kpi-icon-wrapper icon-amber">
                <i class="bi bi-star-fill"></i>
              </div>
              <span class="kpi-badge"
                [ngClass]="analytics()!.trends.satisfactionChange >= 0 ? 'badge-positive' : 'badge-negative'">
                <i class="bi"
                  [ngClass]="analytics()!.trends.satisfactionChange >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short'"></i>
                {{ analytics()!.trends.satisfactionChange }}%
              </span>
            </div>
            <div>
              <p class="kpi-label">Satisfaction</p>
              <h3 class="kpi-value">{{ analytics()!.kpis.patientSatisfaction }}%</h3>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">

          <div class="chart-card xl:col-span-2 flex flex-col">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
              <div>
                <h3 class="chart-title">Appointment Activity</h3>
                <p class="chart-subtitle">Monthly breakdown of appointment status</p>
              </div>
              <div class="chart-legend">
                <div class="legend-item cursor-pointer hover:opacity-80">
                  <div class="legend-dot bg-emerald-500"></div>
                  <span>Completed</span>
                </div>
                <div class="legend-item cursor-pointer hover:opacity-80">
                  <div class="legend-dot bg-amber-400"></div>
                  <span>Cancelled</span>
                </div>
                <div class="legend-item cursor-pointer hover:opacity-80">
                  <div class="legend-dot bg-red-400"></div>
                  <span>No-Show</span>
                </div>
              </div>
            </div>

            <div class="relative w-full h-[320px] mt-4 select-none">
              <svg class="w-full h-full overflow-visible" viewBox="0 0 1000 340" preserveAspectRatio="none">
                <defs>
                  <!-- Gradients -->
                  <linearGradient id="gradCompleted" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#10b981" stop-opacity="0.2" />
                    <stop offset="100%" stop-color="#10b981" stop-opacity="0" />
                  </linearGradient>
                  <linearGradient id="gradCancelled" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#fbbf24" stop-opacity="0.2" />
                    <stop offset="100%" stop-color="#fbbf24" stop-opacity="0" />
                  </linearGradient>
                  <linearGradient id="gradNoShow" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#f87171" stop-opacity="0.2" />
                    <stop offset="100%" stop-color="#f87171" stop-opacity="0" />
                  </linearGradient>
                </defs>

                <!-- Grid Lines -->
                <line x1="0" y1="0" x2="1000" y2="0" stroke="var(--border)" stroke-opacity="0.5" stroke-dasharray="4" />
                <line x1="0" y1="100" x2="1000" y2="100" stroke="var(--border)" stroke-opacity="0.5"
                  stroke-dasharray="4" />
                <line x1="0" y1="200" x2="1000" y2="200" stroke="var(--border)" stroke-opacity="0.5"
                  stroke-dasharray="4" />
                <line x1="0" y1="300" x2="1000" y2="300" stroke="var(--border)" stroke-opacity="0.5" />

                <!-- Areas -->
                <path [attr.d]="getTrendAreaPath('completed', 1000, 300)" fill="url(#gradCompleted)"
                  class="transition-all duration-500" />
                <path [attr.d]="getTrendAreaPath('cancelled', 1000, 300)" fill="url(#gradCancelled)"
                  class="transition-all duration-500" />
                <path [attr.d]="getTrendAreaPath('noShow', 1000, 300)" fill="url(#gradNoShow)"
                  class="transition-all duration-500" />

                <!-- Lines -->
                <path [attr.d]="getTrendPath('completed', 1000, 300)" fill="none" stroke="#10b981" stroke-width="3"
                  stroke-linecap="round" stroke-linejoin="round"
                  class="filter drop-shadow-sm transition-all duration-500" />
                <path [attr.d]="getTrendPath('cancelled', 1000, 300)" fill="none" stroke="#fbbf24" stroke-width="3"
                  stroke-linecap="round" stroke-linejoin="round"
                  class="filter drop-shadow-sm transition-all duration-500" />
                <path [attr.d]="getTrendPath('noShow', 1000, 300)" fill="none" stroke="#f87171" stroke-width="3"
                  stroke-linecap="round" stroke-linejoin="round"
                  class="filter drop-shadow-sm transition-all duration-500" />

                <!-- Points & Labels -->
                <g *ngFor="let point of getTrendPoints('completed', 1000, 300); let last = last">
                  <!-- X-Axis Labels (Only show once using one of the series loops) -->
                  <text [attr.x]="point.x" y="330" text-anchor="middle"
                    class="text-xs font-semibold fill-slate-500 dark:fill-slate-400" style="font-size: 14px;">{{
                    point.label }}</text>

                  <!-- Dots -->
                  <circle [attr.cx]="point.x" [attr.cy]="point.y" r="4" fill="#10b981" stroke="white" stroke-width="2"
                    class="hover:r-6 transition-all cursor-pointer">
                    <title>{{ point.val }} Completed</title>
                  </circle>
                </g>

                <g *ngFor="let point of getTrendPoints('cancelled', 1000, 300)">
                  <circle [attr.cx]="point.x" [attr.cy]="point.y" r="4" fill="#fbbf24" stroke="white" stroke-width="2"
                    class="hover:r-6 transition-all cursor-pointer">
                    <title>{{ point.val }} Cancelled</title>
                  </circle>
                </g>

                <g *ngFor="let point of getTrendPoints('noShow', 1000, 300)">
                  <circle [attr.cx]="point.x" [attr.cy]="point.y" r="4" fill="#f87171" stroke="white" stroke-width="2"
                    class="hover:r-6 transition-all cursor-pointer">
                    <title>{{ point.val }} No-Show</title>
                  </circle>
                </g>
              </svg>
            </div>
          </div>

          <!-- Appointment Types (Donut) -->
          <div class="chart-card flex flex-col">
            <div>
              <h3 class="chart-title">Consultation Types</h3>
              <p class="chart-subtitle">Distribution by category</p>
            </div>

            <div class="donut-container">
              <svg viewBox="0 0 36 36" class="donut-svg">
                <!-- Background Circle -->
                <path class="text-slate-100 dark:text-slate-800"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke="currentColor" stroke-width="2.5" />

                <!-- Segments -->
                <circle *ngFor="let seg of getDonutSegments()" class="donut-segment"
                  [attr.stroke-dasharray]="seg.dashArray" [attr.stroke-dashoffset]="seg.offset"
                  [attr.stroke]="seg.color" cx="18" cy="18" r="15.9155" fill="none" stroke-width="2.5"
                  stroke-linecap="round" />
              </svg>

              <div class="donut-center">
                <span class="donut-total-value">{{ analytics()!.kpis.totalAppointments }}</span>
                <span class="donut-total-label">Total</span>
              </div>
            </div>

            <div class="type-legend">
              <div *ngFor="let seg of getDonutSegments()" class="type-item">
                <div class="type-label-wrapper">
                  <div class="type-color-indicator" [style.background-color]="seg.color"></div>
                  <span class="type-name">{{ seg.label }}</span>
                </div>
                <span class="type-count">{{ seg.count }}</span>
              </div>
            </div>
          </div>

          <!-- Patient Satisfaction (Line Area) -->
          <div class="chart-card xl:col-span-3">
            <div class="flex flex-col sm:flex-row justify-between items-end mb-6">
              <div>
                <h3 class="chart-title">Satisfaction Trend</h3>
                <p class="chart-subtitle">Patient rating performance over time</p>
              </div>
              <div class="text-right">
                <div class="current-score-badge">{{ analytics()!.kpis.patientSatisfaction }}%</div>
                <div class="score-label">Current Score</div>
              </div>
            </div>

            <div class="satisfaction-chart-container">
              <svg class="satisfaction-svg" preserveAspectRatio="none" viewBox="0 0 1000 300">
                <defs>
                  <linearGradient id="satisfactionGradient" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#22c55e" stop-opacity="0.2" />
                    <stop offset="100%" stop-color="#22c55e" stop-opacity="0" />
                  </linearGradient>

                  <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                    <feMerge>
                      <feMergeNode in="coloredBlur" />
                      <feMergeNode in="SourceGraphic" />
                    </feMerge>
                  </filter>
                </defs>

                <!-- Grid -->
                <line x1="0" y1="225" x2="1000" y2="225" class="grid-line" />
                <line x1="0" y1="150" x2="1000" y2="150" class="grid-line grid-line-dashed" />
                <line x1="0" y1="75" x2="1000" y2="75" class="grid-line grid-line-dashed" />

                <!-- Area Fill -->
                <path [attr.d]="getReviewFillPath(1000, 300)" fill="url(#satisfactionGradient)"
                  class="satisfaction-area" />

                <!-- Line -->
                <path [attr.d]="getSatisfactionLinePath(1000, 300)" stroke="#16a34a" fill="none"
                  class="satisfaction-line" filter="url(#glow)" />

                <!-- Data Points -->
                <!-- Use a getter for points to avoid complexity in template if possible, or simple ngFor -->
                <!-- Note: getSatisfactionPoints is not year implemented in TS but I will add it next -->
                <!-- For now, I'll rely on the TS update happening right after this -->
                <g *ngFor="let point of getSatisfactionPoints(1000, 300)">
                  <circle [attr.cx]="point.x" [attr.cy]="point.y" r="6" fill="#16a34a" stroke="white" stroke-width="2"
                    class="cursor-pointer transition-all duration-300 hover:r-8" />
                </g>
              </svg>
            </div>
          </div>

        </div>
      </div>
    </div>
  </main>
</div>