<app-doctor-header></app-doctor-header>
<main class="main" aria-label="Patient Details">
  <ng-template #loading>
    <div class="loading-state">Loading patient details...</div>
  </ng-template>
  <ng-template #noData>
    <div class="empty-state">No patient data found.</div>
  </ng-template>
  <ng-container *ngIf="!isLoading(); else loading">
    <ng-container *ngIf="detail() as detailData; else noData">
      <button (click)="navigate('/doctor/patients')" class="btn btn-ghost mb-4" style="outline: 2px solid #16a34a; outline-offset: 2px; min-width: 44px; min-height: 44px;" tabindex="0"><i class="bi bi-arrow-left"></i> Back to Patients</button>
      <section class="card flex flex-wrap items-center justify-between gap-6 mb-6" style="color: #fff; padding: 24px;">
        <div class="flex items-center gap-4">
          <div class="avatar-lg" [style.background-image]="patient()?.avatar ? 'url(' + patient()?.avatar + ')' : ''" [style.background-size]="'cover'" [style.background-position]="'center'" aria-label="Patient Avatar">
            <span *ngIf="!patient()?.avatar">{{ getInitials() }}</span>
          </div>
          <div>
            <h1 class="font-bold text-2xl mb-1" style="color: #fff;">{{ getFullName() }}</h1>
            <span class="badge" [attr.aria-label]="'Status: ' + (stats()?.lastStatus | titlecase)">
              <i *ngIf="stats()?.lastStatus === 'completed'" aria-hidden="true">✔</i>
              <i *ngIf="stats()?.lastStatus === 'cancelled'" aria-hidden="true">✖</i>
              {{ stats()?.lastStatus | titlecase }}
            </span>
            <div class="text-muted text-sm" style="color: #fff;">{{ patient()?.email }} &bull; {{ patient()?.phoneNumber }}</div>
            <div class="text-xs text-muted" style="color: #fff;">Last seen: {{ formatLastSeen() }}</div>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-ghost btn" (click)="openProfileModal()" style="outline: 2px solid #fff; outline-offset: 2px; min-width: 44px; min-height: 44px;" tabindex="0"><i class="bi bi-person-badge"></i> Full Profile</button>
          <button class="btn-ghost btn" (click)="messagePatient()" style="outline: 2px solid #fff; outline-offset: 2px; min-width: 44px; min-height: 44px;" tabindex="0"><i class="bi bi-chat-dots"></i> Message</button>
        </div>
      </section>
      <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6" aria-label="Patient Statistics">
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Total Visits</div><div class="font-bold text-2xl">{{ stats()?.totalVisits || 0 }}</div></div>
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Completed</div><div class="font-bold text-2xl">{{ stats()?.completedVisits || 0 }}</div></div>
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Cancelled</div><div class="font-bold text-2xl">{{ stats()?.cancelledVisits || 0 }}</div></div>
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Records</div><div class="font-bold text-2xl">{{ stats()?.totalRecords || 0 }}</div></div>
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Prescriptions</div><div class="font-bold text-2xl">{{ stats()?.totalPrescriptions || 0 }}</div></div>
        <div class="stat-card" style="color: #fff; padding: 16px;"><div>Next Follow-up</div><div class="font-bold text-xl">{{ stats()?.nextFollowUp ? (stats()?.nextFollowUp | date:'MMM d') : 'None' }}</div></div>
      </section>
      <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" aria-label="Patient Information">
        <div class="card" style="color: #fff; padding: 16px;">
          <h2 class="font-bold mb-2 text-xs" style="color: #fff;">PERSONAL INFORMATION</h2>
          <div>Patient ID: <span class="font-semibold">{{ patient()?.patientId ? patient()?.patientId : 'N/A' }}</span></div>
          <div>Age: <span class="font-semibold">{{ getAge() }}</span></div>
          <div>Gender: <span class="font-semibold">{{ patient()?.gender ? (patient()?.gender | titlecase) : 'N/A' }}</span></div>
          <div>Blood Type: <span class="font-semibold">{{ patient()?.bloodType ? patient()?.bloodType : 'Unknown' }}</span></div>
        </div>
        <div class="card" style="color: #fff; padding: 16px;">
          <h2 class="font-bold mb-2 text-xs" style="color: #fff;">CONTACT DETAILS</h2>
          <div>Email: <span class="font-semibold">{{ patient()?.email ? patient()?.email : 'N/A' }}</span></div>
          <div>Phone: <span class="font-semibold">{{ patient()?.phoneNumber ? patient()?.phoneNumber : 'N/A' }}</span></div>
          <div>Address: <span class="font-semibold">{{ patient()?.address ? patient()?.address : 'N/A' }}</span></div>
        </div>
        <div class="card" style="color: #fff; padding: 16px;">
          <h2 class="font-bold mb-2 text-xs" style="color: #fff;">MEDICAL INFO</h2>
          <div>Allergies: <span class="font-semibold">{{ patient()?.allergies ? patient()?.allergies : 'None reported' }}</span></div>
          <div>Emergency Contact: <span class="font-semibold">{{ patient()?.emergencyContact ? patient()?.emergencyContact : 'Not provided' }}</span></div>
        </div>
      </section>
      <!-- Tabs Section -->
      <section class="card" style="color: #fff; padding: 24px;">
        <nav class="flex border-b mb-4" role="tablist" aria-label="Patient Tabs">
          <button (click)="setActiveTab('appointments')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'appointments' ? 'font-bold text-primary' : ''" role="tab" [attr.aria-selected]="activeTab() === 'appointments'" tabindex="0" style="outline: 2px solid #16a34a; outline-offset: 2px; min-width: 44px; min-height: 44px;">Appointments <span class="badge ml-2">{{ appointments().length }}</span></button>
          <button (click)="setActiveTab('records')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'records' ? 'font-bold text-primary' : ''" role="tab" [attr.aria-selected]="activeTab() === 'records'" tabindex="0" style="outline: 2px solid #16a34a; outline-offset: 2px; min-width: 44px; min-height: 44px;">Medical Records <span class="badge ml-2">{{ medicalRecords().length }}</span></button>
          <button (click)="setActiveTab('prescriptions')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'prescriptions' ? 'font-bold text-primary' : ''" role="tab" [attr.aria-selected]="activeTab() === 'prescriptions'" tabindex="0" style="outline: 2px solid #16a34a; outline-offset: 2px; min-width: 44px; min-height: 44px;">Prescriptions <span class="badge ml-2">{{ prescriptions().length }}</span></button>
        </nav>
        <div>
          <div *ngIf="activeTab() === 'appointments'">
            <div *ngIf="appointments().length; else noAppointments">
              <div *ngFor="let appt of appointments()" class="appointment-card mb-2" style="color: #fff;">
                <div class="font-bold">{{ appt.type | titlecase }} Consultation</div>
                <div class="text-muted text-sm" style="color: #fff;">{{ appt.date | date:'EEEE, MMMM d, y' }} at {{ appt.time }}</div>
                <div *ngIf="appt.reason" class="text-xs text-muted mt-1" style="color: #fff;">{{ appt.reason }}</div>
                <span class="badge" [attr.aria-label]="'Status: ' + (appt.status | titlecase)">
                  <i *ngIf="appt.status === 'completed'" aria-hidden="true">✔</i>
                  <i *ngIf="appt.status === 'cancelled'" aria-hidden="true">✖</i>
                  {{ appt.status | titlecase }}
                </span>
                <div class="flex gap-2">
                  <button *ngIf="appt.status === 'confirmed'" (click)="startConsultation(appt.id)" class="btn btn-ghost" style="outline: 2px solid #fff; outline-offset: 2px; min-width: 44px; min-height: 44px;" tabindex="0"><i class="bi bi-play-fill"></i></button>
                </div>
              </div>
            </div>
            <ng-template #noAppointments>
              <div class="empty-state" style="color: #fff;">No appointments found.</div>
            </ng-template>
          </div>
          <div *ngIf="activeTab() === 'records'">
            <div *ngIf="medicalRecords().length; else noRecords">
              <div *ngFor="let record of medicalRecords()" class="appointment-card mb-2" style="color: #fff;">
                <div class="font-bold">{{ record.title }}</div>
                <div class="text-muted text-sm" style="color: #fff;">{{ record.recordDate | date:'MMMM d, y' }}</div>
                <div *ngIf="record.notes" class="text-xs text-muted mt-1" style="color: #fff;">{{ record.notes }}</div>
                <span class="badge" [attr.aria-label]="'Type: ' + (record.type | titlecase)">{{ record.type | titlecase }}</span>
              </div>
            </div>
            <ng-template #noRecords>
              <div class="empty-state" style="color: #fff;">No medical records found.</div>
            </ng-template>
          </div>
          <div *ngIf="activeTab() === 'prescriptions'">
            <div *ngIf="prescriptions().length; else noPrescriptions">
              <div *ngFor="let rx of prescriptions()" class="appointment-card mb-2" style="color: #fff;">
                <div class="font-bold">{{ rx.medication }}</div>
                <div class="text-muted text-sm" style="color: #fff;">{{ rx.dosage }} • {{ rx.frequency }} • {{ rx.duration }}</div>
                <div class="text-xs text-muted mt-1" style="color: #fff;">Prescribed {{ rx.createdAt | date:'MMMM d, y' }}</div>
                <span class="badge" [attr.aria-label]="'Status: ' + (rx.status | titlecase)">
                  <i *ngIf="rx.status === 'completed'" aria-hidden="true">✔</i>
                  <i *ngIf="rx.status === 'cancelled'" aria-hidden="true">✖</i>
                  {{ rx.status | titlecase }}
                </span>
              </div>
            </div>
            <ng-template #noPrescriptions>
              <div class="empty-state" style="color: #fff;">No prescriptions found.</div>
            </ng-template>
          </div>
        </div>
      </section>
    </ng-container>
  </ng-container>
</main>
