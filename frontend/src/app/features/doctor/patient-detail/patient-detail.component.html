<app-doctor-header></app-doctor-header>
<div class="main">
  <ng-container *ngIf="!isLoading(); else loading">
    <ng-container *ngIf="detail() as detailData; else noData">
      <button (click)="navigate('/doctor/patients')" class="btn btn-ghost mb-4"><i class="bi bi-arrow-left"></i> Back to Patients</button>
      <div class="card flex flex-wrap items-center justify-between gap-6 mb-6">
        <div class="flex items-center gap-4">
          <div class="avatar-lg" [style.background-image]="patient()?.avatar ? 'url(' + patient()?.avatar + ')' : ''" [style.background-size]="'cover'" [style.background-position]="'center'">
            <span *ngIf="!patient()?.avatar">{{ getInitials() }}</span>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="font-bold text-lg">{{ getFullName() }}</span>
              <span class="badge">{{ stats()?.lastStatus | titlecase }}</span>
            </div>
            <div class="text-muted text-sm">{{ patient()?.email }} &bull; {{ patient()?.phoneNumber }}</div>
            <div class="text-xs text-muted">Last seen: {{ formatLastSeen() }}</div>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-ghost btn" (click)="openProfileModal()"><i class="bi bi-person-badge"></i> Full Profile</button>
          <button class="btn-ghost btn" (click)="messagePatient()"><i class="bi bi-chat-dots"></i> Message</button>
          <button class="btn" (click)="navigate('/doctor/appointments/new?patientId=' + patient()?.id)"><i class="bi bi-calendar-plus"></i> New Appointment</button>
        </div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="stat-card"><div>Total Visits</div><div class="font-bold text-xl">{{ stats()?.totalVisits || 0 }}</div></div>
        <div class="stat-card"><div>Completed</div><div class="font-bold text-xl">{{ stats()?.completedVisits || 0 }}</div></div>
        <div class="stat-card"><div>Cancelled</div><div class="font-bold text-xl">{{ stats()?.cancelledVisits || 0 }}</div></div>
        <div class="stat-card"><div>Records</div><div class="font-bold text-xl">{{ stats()?.totalRecords || 0 }}</div></div>
        <div class="stat-card"><div>Prescriptions</div><div class="font-bold text-xl">{{ stats()?.totalPrescriptions || 0 }}</div></div>
        <div class="stat-card"><div>Next Follow-up</div><div class="font-bold text-base">{{ stats()?.nextFollowUp ? (stats()?.nextFollowUp | date:'MMM d') : 'None' }}</div></div>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="card">
          <div class="font-bold mb-2 text-muted text-xs">PERSONAL INFORMATION</div>
          <div>Patient ID: <span class="font-semibold">{{ patient()?.patientId || 'N/A' }}</span></div>
          <div>Age: <span class="font-semibold">{{ getAge() }}</span></div>
          <div>Gender: <span class="font-semibold">{{ patient()?.gender | titlecase || 'N/A' }}</span></div>
          <div>Blood Type: <span class="font-semibold">{{ patient()?.bloodType || 'Unknown' }}</span></div>
        </div>
        <div class="card">
          <div class="font-bold mb-2 text-muted text-xs">CONTACT DETAILS</div>
          <div>Email: <span class="font-semibold">{{ patient()?.email || 'N/A' }}</span></div>
          <div>Phone: <span class="font-semibold">{{ patient()?.phoneNumber || 'N/A' }}</span></div>
          <div>Address: <span class="font-semibold">{{ patient()?.address || 'N/A' }}</span></div>
        </div>
        <div class="card">
          <div class="font-bold mb-2 text-muted text-xs">MEDICAL INFO</div>
          <div>Allergies: <span class="font-semibold">{{ patient()?.allergies || 'None reported' }}</span></div>
          <div>Emergency Contact: <span class="font-semibold">{{ patient()?.emergencyContact || 'Not provided' }}</span></div>
        </div>
      </div>
      <!-- Tabs Section -->
      <div class="card">
        <div class="flex border-b mb-4">
          <button (click)="setActiveTab('appointments')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'appointments' ? 'font-bold text-primary' : ''">Appointments <span class="badge ml-2">{{ appointments().length }}</span></button>
          <button (click)="setActiveTab('records')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'records' ? 'font-bold text-primary' : ''">Medical Records <span class="badge ml-2">{{ medicalRecords().length }}</span></button>
          <button (click)="setActiveTab('prescriptions')" class="btn-ghost flex-1" [ngClass]="activeTab() === 'prescriptions' ? 'font-bold text-primary' : ''">Prescriptions <span class="badge ml-2">{{ prescriptions().length }}</span></button>
        </div>
        <div>
          <div *ngIf="activeTab() === 'appointments'">
            <div *ngIf="appointments().length; else noAppointments">
              <div *ngFor="let appt of appointments()" class="appointment-card mb-2">
                <div class="font-bold">{{ appt.type | titlecase }} Consultation</div>
                <div class="text-muted text-sm">{{ appt.date | date:'EEEE, MMMM d, y' }} at {{ appt.time }}</div>
                <div *ngIf="appt.reason" class="text-xs text-muted mt-1">{{ appt.reason }}</div>
                <span class="badge">{{ appt.status | titlecase }}</span>
                <div class="flex gap-2">
                  <button *ngIf="appt.status === 'confirmed'" (click)="startConsultation(appt.id)" class="btn btn-ghost"><i class="bi bi-play-fill"></i></button>
                  <button *ngIf="appt.status === 'completed'" (click)="viewConsultation(appt.id)" class="btn btn-ghost"><i class="bi bi-eye"></i></button>
                </div>
              </div>
            </div>
            <ng-template #noAppointments>
              <div class="empty-state">No appointments found.</div>
            </ng-template>
          </div>
          <div *ngIf="activeTab() === 'records'">
            <div *ngIf="medicalRecords().length; else noRecords">
              <div *ngFor="let record of medicalRecords()" class="appointment-card mb-2">
                <div class="font-bold">{{ record.title }}</div>
                <div class="text-muted text-sm">{{ record.recordDate | date:'MMMM d, y' }}</div>
                <div *ngIf="record.notes" class="text-xs text-muted mt-1">{{ record.notes }}</div>
                <span class="badge">{{ record.type | titlecase }}</span>
              </div>
            </div>
            <ng-template #noRecords>
              <div class="empty-state">No medical records found.</div>
            </ng-template>
          </div>
          <div *ngIf="activeTab() === 'prescriptions'">
            <div *ngIf="prescriptions().length; else noPrescriptions">
              <div *ngFor="let rx of prescriptions()" class="appointment-card mb-2">
                <div class="font-bold">{{ rx.medication }}</div>
                <div class="text-muted text-sm">{{ rx.dosage }} • {{ rx.frequency }} • {{ rx.duration }}</div>
                <div class="text-xs text-muted mt-1">Prescribed {{ rx.createdAt | date:'MMMM d, y' }}</div>
                <span class="badge">{{ rx.status | titlecase }}</span>
              </div>
            </div>
            <ng-template #noPrescriptions>
              <div class="empty-state">No prescriptions found.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>
