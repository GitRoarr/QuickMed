<form class="patient-detail" *ngIf="!loading(); else loadingTpl" [formGroup]="form" (ngSubmit)="save()">
  <header class="page-head">
    <div class="left">
      <button class="ghost" type="button" (click)="goBack()">
        <i class="bi bi-arrow-left"></i>
        Back to patients
      </button>
      <div>
        <p class="eyebrow">Patient profile</p>
        <h1>{{ getPatientName() }}</h1>
        <p class="muted">{{ getPatientEmail() }} â€¢ ID: {{ getPatientIdLabel() }}</p>
      </div>
    </div>
    <div class="right">
      <div class="pill" *ngIf="patient()?.bloodType">Blood type: {{ patient()?.bloodType }}</div>
      <div class="pill ghost" *ngIf="getAllergyList().length">{{ getAllergyList().length }} allergies</div>
      <button class="primary" type="submit" [disabled]="saving() || form.invalid">{{ saving() ? 'Saving...' : 'Save changes' }}</button>
    </div>
  </header>

  <div class="grid">
    <section class="card span-2">
      <div class="card-head">
        <div>
          <p class="eyebrow">Safety</p>
          <h3>Blood type & allergies</h3>
          <p class="muted">Patient can edit in their portal; doctors can confirm or update here.</p>
        </div>
      </div>
      <div class="two-col">
        <label>
          <span>Blood type</span>
          <select formControlName="bloodType">
            <option value="">Select</option>
            <option *ngFor="let t of bloodTypes" [value]="t">{{ t }}</option>
          </select>
        </label>
        <label>
          <span>Allergies (comma separated)</span>
          <textarea rows="2" formControlName="allergiesText" placeholder="Peanuts, Penicillin..."></textarea>
        </label>
      </div>
      <div class="chips" *ngIf="getAllergyList().length">
        <span class="chip" *ngFor="let a of getAllergyList()">{{ a }}</span>
      </div>
    </section>

    <section class="card span-2">
      <div class="card-head">
        <div>
          <p class="eyebrow">Vitals</p>
          <h3>Capture & confirm</h3>
        </div>
      </div>
      <div class="two-col">
        <label>
          <span>BP Systolic</span>
          <input type="number" formControlName="bloodPressureSystolic" placeholder="120" />
        </label>
        <label>
          <span>BP Diastolic</span>
          <input type="number" formControlName="bloodPressureDiastolic" placeholder="80" />
        </label>
        <label>
          <span>Heart rate (bpm)</span>
          <input type="number" formControlName="heartRate" placeholder="72" />
        </label>
        <label>
          <span>Height (cm)</span>
          <input type="number" formControlName="heightCm" placeholder="170" />
        </label>
        <label>
          <span>Weight (kg)</span>
          <input type="number" formControlName="weightKg" placeholder="70" />
        </label>
        <label>
          <span>BMI (auto)</span>
          <input type="number" formControlName="bmi" placeholder="24" />
        </label>
      </div>
      <div class="bmi-bar" *ngIf="form.getRawValue().bmi as bmi">
        <p class="muted">Calculated BMI: {{ bmi }}</p>
      </div>
    </section>
  </div>
</form>

<ng-template #loadingTpl>
  <div class="loading">Loading patient...</div>
</ng-template>
