<div class="flex-1 flex flex-col font-sans transition-colors duration-200">

  <main class="flex-1 flex flex-col overflow-hidden relative">

    <app-doctor-header [initials]="getDoctorInitials()" [avatarUrl]="currentUser()?.avatar"
      [unreadNotifications]="unreadNotifications()"></app-doctor-header>

    <div class="flex-1 overflow-y-auto px-8 pb-8">

      <header class="mb-8">
        <h1 class="text-2xl font-bold text-[var(--text-primary)] mb-2">My Patients</h1>
        <p class="text-[var(--text-secondary)]">Care continuity and patient management.</p>
      </header>

      <div class="stats-grid mb-6">
        <div class="stat-card">
          <div class="stat-value">{{ activePatients() }}</div>
          <div class="stat-label">Active Patients</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ newThisWeek() }}</div>
          <div class="stat-label">New This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ followUpsDue() }}</div>
          <div class="stat-label">Follow-ups Due</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ totalVisits() }}</div>
          <div class="stat-label">Total Visits</div>
        </div>
      </div>

      <div class="patients-toolbar mb-6">
        <div class="search-wrap">
          <i class="bi bi-search"></i>
          <input
            type="text"
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            placeholder="Search by name, phone, condition..."
          />
        </div>

        <div class="filter-pills">
          <button
            *ngFor="let pill of filterPills"
            type="button"
            class="pill"
            [class.active]="statusFilter() === pill.value"
            (click)="statusFilter.set(pill.value)"
          >
            {{ pill.label }}
          </button>
        </div>
      </div>

      <div *ngIf="isLoading()" class="py-12 text-center">
        <div
          class="inline-block w-8 h-8 border-4 border-[var(--border-default)] border-t-[var(--primary)] rounded-full animate-spin">
        </div>
        <p class="text-[var(--text-secondary)] mt-4">Loading patients...</p>
      </div>

      <div *ngIf="!isLoading() && filteredPatients().length === 0"
        class="py-12 text-center bg-[var(--surface-secondary)] rounded-2xl shadow-sm">
        <div
          class="w-16 h-16 bg-[var(--surface-secondary)] rounded-full flex items-center justify-center text-[var(--text-muted)] text-3xl mx-auto mb-4">
          <i class="bi bi-people"></i>
        </div>
        <h3 class="font-bold text-[var(--text-primary)]">No patients found</h3>
        <p class="text-[var(--text-secondary)] text-sm">Try adjusting filters or search.</p>
      </div>

      <div class="patients-grid" *ngIf="!isLoading() && filteredPatients().length > 0">
        <div *ngFor="let p of filteredPatients()" class="patient-card">
          <div class="patient-card__top">
            <div class="patient-avatar">{{ getInitials(p) }}</div>
            <div class="patient-info">
              <div class="patient-name">
                <span>{{ getFullName(p) }}</span>
                <span class="status-tag" [class]="getTagTone(p)">{{ getTag(p) }}</span>
              </div>
              <div class="patient-meta">{{ getPatientMeta(p) }}</div>
            </div>
          </div>

          <div class="patient-stats">
            <div>
              <div class="label">Last Seen</div>
              <div class="value">{{ formatLastSeen(p) }}</div>
            </div>
            <div>
              <div class="label">Visits</div>
              <div class="value">{{ p.totalAppointments }}</div>
            </div>
            <div>
              <div class="label">Status</div>
              <div class="value status" [class]="getTagTone(p)">{{ getTag(p) }}</div>
            </div>
          </div>

          <div class="patient-actions">
            <button type="button" [routerLink]="['/doctor/patients', p.patientId]">Records</button>
            <button type="button" [routerLink]="['/doctor/messages']" [queryParams]="{ patientId: p.patientId }">
              Message
            </button>
            <button type="button" class="primary" [routerLink]="['/call', p.patientId]">Consult</button>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>