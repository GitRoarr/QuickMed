<app-patient-shell active="dashboard">
  <div class="patient-dashboard" *ngIf="!isLoading(); else loadingState">
    <div class="dashboard-header" *ngIf="dashboard() as data">
      <div>
        <p class="eyebrow">Good day</p>
        <h1>Welcome back, {{ data.patient.name }}</h1>
        <p class="muted">Here's a snapshot of your health today.</p>
      </div>
      <a class="primary-btn" routerLink="/patient/appointments">
        <i class="bi bi-plus-circle"></i>
        Book Appointment
      </a>
    </div>

    <div class="vitals-grid" *ngIf="dashboard()">
      <div class="vital-card" *ngFor="let vit of getVitalsCards()">
        <div class="vital-icon">
          <i class="bi" [ngClass]="vit.icon"></i>
        </div>
        <div>
          <p class="vital-label">{{ vit.label }}</p>
          <p class="vital-value">{{ vit.value }}</p>
          <p class="vital-status">{{ vit.status }}</p>
        </div>
      </div>
    </div>

    <div class="stats-grid" *ngIf="dashboard()">
      <div class="stat-pill" *ngFor="let stat of getStatsCards()">
        <i class="bi" [ngClass]="stat.icon"></i>
        <div>
          <p class="pill-label">{{ stat.label }}</p>
          <p class="pill-value">{{ stat.value }}</p>
        </div>
      </div>
    </div>

    <div class="content-grid" *ngIf="dashboard()">
      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Upcoming Appointments</h2>
            <p class="muted">Stay prepared for your next visit.</p>
          </div>
          <a class="text-link" routerLink="/patient/appointments">View all</a>
        </div>

        <div *ngIf="getUpcomingAppointments().length === 0" class="empty-state">
          <p>No upcoming appointments. Book your next visit.</p>
        </div>

        <div class="appointment-card" *ngFor="let apt of getUpcomingAppointments()">
          <div class="appointment-icon" [class.video]="apt.isVideoConsultation">
            <i class="bi" [ngClass]="apt.isVideoConsultation ? 'bi-camera-video' : 'bi-geo-alt'"></i>
          </div>
          <div class="appointment-content">
            <div class="appointment-meta">
              <div>
                <p class="appointment-doctor">{{ apt.doctor }}</p>
                <p class="muted">{{ apt.specialty || 'General Care' }}</p>
              </div>
              <span class="badge" [class.badge-video]="apt.isVideoConsultation">
                {{ apt.isVideoConsultation ? 'Video visit' : 'In-person' }}
              </span>
            </div>
            <div class="appointment-details">
              <div>
                <i class="bi bi-calendar-event"></i>
                <span>{{ apt.appointmentDate | date:'MMM d, y' }}</span>
              </div>
              <div>
                <i class="bi bi-clock"></i>
                <span>{{ apt.appointmentTime }}</span>
              </div>
              <div>
                <i class="bi" [ngClass]="apt.isVideoConsultation ? 'bi-link-45deg' : 'bi-pin-map'"></i>
                <span>{{ apt.location || (apt.isVideoConsultation ? 'Virtual room' : 'Clinic visit') }}</span>
              </div>
            </div>
            <div class="appointment-actions">
              <button class="text-link">Reschedule</button>
              <button class="text-link">Cancel</button>
              <button class="primary-btn subtle" *ngIf="apt.isVideoConsultation">Join</button>
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Current Prescriptions</h2>
            <p class="muted">Medications you're actively taking.</p>
          </div>
          <a class="text-link">Request refill</a>
        </div>

        <div class="prescription-card" *ngFor="let rx of getPrescriptions()">
          <div>
            <p class="prescription-name">{{ rx.medication }}</p>
            <p class="muted">{{ rx.dosage }} â€¢ {{ rx.frequency }}</p>
          </div>
          <div>
            <p class="muted">Prescribed by {{ rx.doctor }}</p>
            <p class="pill-label">{{ rx.duration }}</p>
          </div>
        </div>

        <div *ngIf="getPrescriptions().length === 0" class="empty-state">
          <p>No active prescriptions.</p>
        </div>
      </section>
    </div>

    <section class="panel" *ngIf="dashboard()">
      <div class="panel-header">
        <div>
          <h2>Recent Lab Results</h2>
          <p class="muted">Latest test reports and imaging.</p>
        </div>
      </div>

      <div class="lab-results">
        <div class="lab-item" *ngFor="let lab of getLabResults()">
          <div>
            <p class="lab-title">{{ lab.title }}</p>
            <p class="muted">{{ lab.recordDate ? (lab.recordDate | date:'MMM d, y') : 'Awaiting date' }}</p>
          </div>
          <span class="badge" [class.badge-success]="lab.status === 'available'">{{ lab.status || 'pending' }}</span>
        </div>
        <div *ngIf="getLabResults().length === 0" class="empty-state">
          <p>No lab results yet.</p>
        </div>
      </div>
    </section>
  </div>
</app-patient-shell>

<ng-template #loadingState>
  <app-patient-shell active="dashboard">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading your dashboard...</p>
    </div>
  </app-patient-shell>
</ng-template>
