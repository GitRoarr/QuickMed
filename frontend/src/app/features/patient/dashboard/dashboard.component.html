<div class="container-fluid py-4">

  <!-- ==================== HEADER ==================== -->
  <header class="bg-white shadow-sm rounded-3 mb-4 p-3 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
        <i class="bi bi-shield-fill"></i>
      </div>
      <div>
        <h3 class="mb-0 fw-bold">QuickMed</h3>
        <small class="text-muted">Patient Portal</small>
      </div>
    </div>

    <div class="d-flex align-items-center gap-3">
      <div class="position-relative d-none d-md-block">
        <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
        <input [(ngModel)]="searchQuery" class="form-control ps-5" placeholder="Search appointments, doctors..." style="width:300px;">
      </div>

      <button class="btn btn-danger d-flex align-items-center gap-2" (click)="callEmergency()">
        <i class="bi bi-telephone-fill"></i> Emergency
      </button>

      <div class="position-relative">
        <i class="bi bi-bell fs-4 text-muted"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">2</span>
      </div>

      <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"
           style="width:40px;height:40px;">
        {{ getInitials(user()?.firstName, user()?.lastName) }}
      </div>
    </div>
  </header>

  <!-- ==================== WELCOME ==================== -->
  <section class="mb-4">
    <h2 class="fw-bold">Welcome back, {{ user()?.firstName }} {{ user()?.lastName }}</h2>
    <p class="text-muted">Manage your appointments and health records</p>
  </section>

  <!-- ==================== STATS ==================== -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
            <i class="bi bi-calendar-check"></i>
          </div>
          <div>
            <p class="mb-0 text-muted small">Upcoming</p>
            <h4 class="mb-0 fw-bold">
              <span class="badge bg-success fs-5">{{ stats().upcomingAppointments }}</span>
            </h4>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
            <i class="bi bi-capsule"></i>
          </div>
          <div>
            <p class="mb-0 text-muted small">Active Meds</p>
            <h4 class="mb-0 fw-bold">
              <span class="badge bg-success fs-5">{{ stats().activeMeds }}</span>
            </h4>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
            <i class="bi bi-file-earmark-text"></i>
          </div>
          <div>
            <p class="mb-0 text-muted small">Records</p>
            <h4 class="mb-0 fw-bold">
              <span class="badge bg-primary fs-5">{{ stats().records }}</span>
            </h4>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
            <i class="bi bi-activity"></i>
          </div>
          <div>
            <p class="mb-0 text-muted small">Test Results</p>
            <h4 class="mb-0 fw-bold">
              <span class="badge bg-primary fs-5">{{ stats().testResults }}</span>
            </h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MAIN GRID ==================== -->
  <div class="row g-4">

    <!-- LEFT: TABS + CONTENT -->
    <div class="col-lg-8">

      <!-- TABS -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab() === 'appointments'" (click)="setTab('appointments')">Appointments</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab() === 'history'" (click)="setTab('history')">Medical History</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab() === 'prescriptions'" (click)="setTab('prescriptions')">Prescriptions</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab() === 'tests'" (click)="setTab('tests')">Test Results</button>
        </li>
      </ul>

      <!-- TAB CONTENT -->
      <div class="card border-0 shadow-sm">

        <!-- APPOINTMENTS -->
        <div *ngIf="activeTab() === 'appointments'" class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold">Upcoming Appointments</h5>
            <button class="btn btn-success btn-sm d-flex align-items-center gap-1" (click)="bookAppointment()">
              <i class="bi bi-plus-lg"></i> Book Appointment
            </button>
          </div>

          <div *ngIf="isLoading()" class="text-center py-5">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <div *ngIf="!isLoading() && appointments().length === 0" class="text-center py-5 text-muted">
            <p class="mb-3">No upcoming appointments</p>
            <button class="btn btn-success" (click)="bookAppointment()">Book Your First Appointment</button>
          </div>

          <div *ngFor="let a of appointments()" class="border rounded-3 p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="d-flex align-items-center gap-3">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"
                     style="width:40px;height:40px;">
                  {{ getInitials(a.doctor.firstName, a.doctor.lastName) }}
                </div>
                <div>
                  <h6 class="mb-0">Dr. {{ a.doctor.firstName }} {{ a.doctor.lastName }}</h6>
                  <small class="text-muted">{{ a.doctor.specialty }}</small>
                </div>
              </div>
              <span class="badge"
                    [class.bg-success]="a.status === 'confirmed'"
                    [class.bg-warning]="a.status === 'pending'">
                {{ a.status }}
              </span>
            </div>

            <div class="row g-2 small text-muted mb-2">
              <div class="col-auto"><i class="bi bi-calendar3"></i> {{ a.appointmentDate | date:'MMM d, yyyy' }}</div>
              <div class="col-auto"><i class="bi bi-clock"></i> {{ a.appointmentTime }}</div>
              <div class="col" *ngIf="a.location"><i class="bi bi-geo-alt"></i> {{ a.location }}</div>
            </div>

            <div class="d-flex gap-2">
              <button *ngIf="a.isVideoConsultation && a.status === 'confirmed'" class="btn btn-success btn-sm">
                <i class="bi bi-camera-video"></i> Join Call
              </button>
              <button class="btn btn-outline-secondary btn-sm">Reschedule</button>
              <button class="btn btn-outline-danger btn-sm">Cancel</button>
            </div>
          </div>
        </div>

        <!-- MEDICAL HISTORY -->
        <div *ngIf="activeTab() === 'history'" class="card-body">
          <h5 class="mb-3 fw-bold">Medical History</h5>
          <div *ngFor="let r of medicalHistory()" class="border rounded-3 p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between mb-1">
              <div>
                <h6 class="mb-0">{{ r.diagnosis }}</h6>
                <small class="text-muted">{{ r.doctor }}</small>
              </div>
              <small class="text-muted">{{ r.date | date:'MMM d, yyyy' }}</small>
            </div>
            <p class="mb-0 small text-muted">{{ r.notes }}</p>
          </div>
        </div>

        <!-- PRESCRIPTIONS -->
        <div *ngIf="activeTab() === 'prescriptions'" class="card-body">
          <h5 class="mb-3 fw-bold">Active Prescriptions</h5>
          <div *ngFor="let p of prescriptions()" class="border rounded-3 p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between mb-2">
              <div>
                <h6 class="mb-0">{{ p.medication }}</h6>
                <small class="text-muted">{{ p.dosage }}</small>
              </div>
              <span class="badge"
                    [class.bg-success]="p.status === 'active'"
                    [class.bg-secondary]="p.status === 'completed'">
                {{ p.status }}
              </span>
            </div>
            <div class="small text-muted mb-2">
              <div><strong>Prescribed by:</strong> {{ p.prescribedBy }}</div>
              <div><strong>Start Date:</strong> {{ p.startDate | date:'MMM d, yyyy' }}</div>
              <div><strong>Refills Remaining:</strong> {{ p.refills }}</div>
            </div>
            <button *ngIf="p.status === 'active'" class="btn btn-success w-100" (click)="requestRefill(p)">
              Request Refill
            </button>
          </div>
        </div>

        <!-- TEST RESULTS -->
        <div *ngIf="activeTab() === 'tests'" class="card-body">
          <h5 class="mb-3 fw-bold">Recent Test Results</h5>
          <div *ngFor="let t of testResults()" class="border rounded-3 p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between mb-2">
              <div>
                <h6 class="mb-0">{{ t.test }}</h6>
                <small class="text-muted">Ordered by {{ t.orderedBy }}</small>
              </div>
              <span class="badge"
                    [class.bg-success]="t.status === 'Normal'"
                    [class.bg-warning]="t.status === 'Slightly Elevated'"
                    [class.bg-info]="t.status.includes('Positive')">
                {{ t.status }}
              </span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">{{ t.date | date:'MMM d, yyyy' }}</small>
              <button class="btn btn-outline-success btn-sm" (click)="viewTestDetails(t)">
                View Details
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: SIDEBAR -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Profile Information</h5>

          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"
                 style="width:56px;height:56px;font-size:1.2rem;">
              {{ getInitials(user()?.firstName, user()?.lastName) }}
            </div>
            <div>
              <h6 class="mb-0">{{ user()?.firstName }} {{ user()?.lastName }}</h6>
              <small class="text-muted">Patient ID: {{ user()?.patientId }}</small>
            </div>
          </div>

          <div class="small text-muted">
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-envelope"></i> {{ user()?.email }}</div>
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-telephone"></i> {{ user()?.phoneNumber }}</div>
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-calendar"></i>
              DOB: {{ user()?.dateOfBirth ? (user()?.dateOfBirth | date:'MMMM d, yyyy') : 'â€”' }}
            </div>
            <div class="d-flex align-items-center gap-2 mb-3"><i class="bi bi-droplet"></i> Blood Type: {{ user()?.bloodType }}</div>
          </div>
          <div *ngIf="user()?.allergies?.length">
  <strong class="d-block mb-1">Allergies</strong>
  <div class="d-flex flex-wrap gap-1">
    <span *ngFor="let a of user()!.allergies" class="badge bg-danger text-white">{{ a }}</span>
  </div>
</div>


    


          <button class="btn btn-success w-100 mt-3">Edit Profile</button>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Quick Actions</h5>
          <button class="btn btn-outline-success w-100 mb-2 d-flex align-items-center justify-content-start gap-2">
            <i class="bi bi-calendar-plus"></i> Book Appointment
          </button>
          <button class="btn btn-outline-success w-100 mb-2 d-flex align-items-center justify-content-start gap-2">
            <i class="bi bi-cloud-download"></i> Download Records
          </button>
          <button class="btn btn-outline-success w-100 mb-2 d-flex align-items-center justify-content-start gap-2">
            <i class="bi bi-prescription"></i> Request Prescription
          </button>
          <button class="btn btn-outline-success w-100 d-flex align-items-center justify-content-start gap-2">
            <i class="bi bi-headset"></i> Contact Support
          </button>
        </div>
      </div>
    </div>
  </div>
</div>