<app-patient-shell active="appointments">
  <div class="appointments-page">
    <div class="page-header">
      <div>
        <p class="eyebrow">My Appointments</p>
        <h1>Manage your medical appointments</h1>
      </div>
      <button class="primary-btn" (click)="bookNewAppointment()">
        <i class="bi bi-plus"></i>
        Book Appointment
      </button>
    </div>

    <div class="segment-tabs">
      <button type="button" [class.active]="activeSegment() === 'upcoming'" (click)="setSegment('upcoming')">Upcoming</button>
      <button type="button" [class.active]="activeSegment() === 'completed'" (click)="setSegment('completed')">Completed</button>
    </div>

    <div class="appointments-toolbar">
      <div class="search-field">
        <i class="bi bi-search"></i>
        <input
          type="text"
          placeholder="Search doctors, specialties, locations..."
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()" />
      </div>
      <div class="stats">
        <span>Total: {{ getAppointmentStats().total }}</span>
        <span>Confirmed: {{ getAppointmentStats().confirmed }}</span>
      </div>
    </div>

    <ng-container *ngIf="!isLoading(); else loadingState">
      <div class="appointment-card" *ngFor="let apt of visibleAppointments()">
        <div class="appointment-icon" [class.video]="apt.isVideoConsultation">
          <i class="bi" [ngClass]="apt.isVideoConsultation ? 'bi-camera-video' : 'bi-geo-alt'"></i>
        </div>
        <div class="appointment-details">
          <div class="details-header">
            <div>
              <p class="doctor">Dr. {{ apt.doctor?.firstName }} {{ apt.doctor?.lastName }}</p>
              <p class="muted">{{ apt.doctor?.specialty }}</p>
            </div>
            <span class="badge" [ngClass]="apt.status">{{ apt.status }}</span>
          </div>
          <div class="details-grid">
            <div><i class="bi bi-calendar-event"></i>{{ apt.appointmentDate | date:'MMM d, y' }}</div>
            <div><i class="bi bi-clock"></i>{{ apt.appointmentTime }}</div>
            <div><i class="bi bi-geo-alt"></i>{{ apt.location || (apt.isVideoConsultation ? 'Virtual visit' : 'Clinic') }}</div>
          </div>
          <div class="actions">
            <button class="text-btn" (click)="rescheduleAppointment(apt.id)">Reschedule</button>
            <button class="text-btn" (click)="cancelAppointment(apt.id)">Cancel</button>
            <button class="primary-btn subtle" *ngIf="apt.isVideoConsultation && apt.status === 'confirmed'" (click)="joinVideoCall(apt.id)">
              Join
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="visibleAppointments().length === 0">
        <p>No appointments found.</p>
        <button class="primary-btn" (click)="bookNewAppointment()">Book your next visit</button>
      </div>
    </ng-container>
  </div>
</app-patient-shell>

<ng-template #loadingState>
  <div class="empty-state">
    <div class="spinner"></div>
    Loading appointments...
  </div>
</ng-template>

