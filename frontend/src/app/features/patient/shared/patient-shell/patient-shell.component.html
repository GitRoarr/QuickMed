<div class="patient-shell" [class.sidebar-open]="sidebarOpen" [class.dark]="themeService.isDarkMode()">
  <aside class="patient-shell__sidebar">
    <div class="patient-shell__brand" (click)="navigate('/')" title="Back to Home">
      <div class="brand-container">
        <div class="brand-icon">
          <img src="assets/images/QuickMed-Logo.png" alt="QuickMed Logo" />
        </div>
        <div class="brand-text">
          <p class="brand-title">QuickMed</p>
          <p class="brand-subtitle">Patient Portal</p>
        </div>
      </div>
    </div>

    <nav class="patient-shell__nav" [attr.aria-hidden]="!sidebarOpen && mobile">
      <a
        *ngFor="let item of menuItems"
        class="patient-shell__nav-item"
        [routerLink]="item.route"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: item.exact !== false }"
        (click)="closeSidebar()"
      >
        <i class="bi" [ngClass]="item.icon"></i>
        <span>{{ item.label }}</span>
      </a>
    </nav>

    <div class="patient-shell__profile" *ngIf="user as current">
      <div class="avatar">
        <img *ngIf="current.avatar; else initials" [src]="current.avatar" alt="{{ current.firstName }}" />
        <ng-template #initials>
          {{ (current.firstName.charAt(0) || 'A') + (current.lastName.charAt(0) || 'J') }}
        </ng-template>
      </div>
      <div>
        <p class="profile-name">{{ current.firstName }} {{ current.lastName }}</p>
        <p class="profile-id">{{ current.patientId || current.id }}</p>
      </div>
    </div>

    <button class="patient-shell__logout" type="button" (click)="logout(); closeSidebar()">
      <i class="bi bi-box-arrow-right"></i>
      Logout
    </button>
  </aside>

  <main class="patient-shell__content">
    <div class="patient-shell__topbar">
      <button class="patient-shell__icon-btn" type="button" [routerLink]="'/patient/messages'" title="Messages">
        <i class="bi bi-chat-dots"></i>
        <span class="patient-shell__badge" *ngIf="unreadMessages() > 0">{{ unreadMessages() }}</span>
      </button>
      <button class="patient-shell__icon-btn" type="button" title="Notifications" (click)="toggleNotifications($event)">
        <i class="bi bi-bell"></i>
        <span class="patient-shell__badge" *ngIf="unreadNotifications() > 0">{{ unreadNotifications() }}</span>
      </button>
      <div
        class="patient-shell__notifications"
        *ngIf="notificationsOpen()"
        (click)="$event.stopPropagation()"
      >
        <div class="notifications-header">
          <div>
            <p class="notifications-title">Notifications</p>
            <p class="notifications-subtitle" *ngIf="unreadNotifications() > 0">
              {{ unreadNotifications() }} unread
            </p>
          </div>
          <button
            class="notifications-action"
            type="button"
            (click)="markAllNotificationsRead($event)"
            [disabled]="unreadNotifications() === 0"
          >
            Mark all read
          </button>
        </div>

        <div class="notifications-body" *ngIf="!isLoadingNotifications(); else notificationsLoading">
          <button
            class="notification-item"
            *ngFor="let item of notifications()"
            type="button"
            [class.unread]="!item.read"
            (click)="openNotification(item, $event)"
          >
            <div class="notification-icon" [class.unread-dot]="!item.read">
              <i class="bi" [ngClass]="notificationService.getNotificationIcon(item.type)"></i>
            </div>
            <div class="notification-content">
              <div class="notification-row">
                <p class="notification-title">{{ item.title }}</p>
                <span class="notification-time">{{ formatNotificationTime(item.createdAt) }}</span>
              </div>
              <p class="notification-message">{{ item.message }}</p>
              <div class="notification-actions">
                <span
                  class="notification-type"
                  [ngClass]="notificationService.getPriorityColorClass(item.priority)"
                >
                  {{ item.type.replace('_', ' ') }} â€¢ {{ item.priority }}
                </span>
                <button
                  class="notification-mark"
                  type="button"
                  (click)="markNotificationRead(item, $event)"
                  *ngIf="!item.read"
                >
                  Mark read
                </button>
              </div>
            </div>
          </button>

          <div class="notifications-empty" *ngIf="notifications().length === 0">
            <p>No notifications yet.</p>
          </div>
        </div>

        <ng-template #notificationsLoading>
          <div class="notifications-loading">
            <div class="loader"></div>
            <p>Loading notifications...</p>
          </div>
        </ng-template>

        <div class="notifications-footer">
          <button class="notifications-link" type="button" (click)="navigate('/patient/settings')">
            Notification settings
          </button>
        </div>
      </div>
      <button class="patient-shell__icon-btn" type="button" (click)="toggleTheme()" title="Toggle theme">
        <i class="bi" [ngClass]="themeService.isDarkMode() ? 'bi-moon' : 'bi-brightness-high'"></i>
      </button>
      <button class="hamburger" type="button" aria-label="Toggle menu" (click)="toggleSidebar()" *ngIf="mobile">
        <span class="hamburger-box">
          <span class="hamburger-inner"></span>
        </span>
      </button>
    </div>
    <ng-content></ng-content>
  </main>
</div>
