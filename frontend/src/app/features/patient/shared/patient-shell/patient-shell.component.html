<div class="patient-shell" [class.sidebar-open]="sidebarOpen" [class.dark]="themeService.isDarkMode()">

  <!-- Premium Hamburger Button (Mobile) -->
  <button type="button" class="hamburger-btn" [class.is-active]="sidebarOpen" (click)="toggleSidebar()"
    aria-label="Toggle sidebar">
    <span class="hamburger-box">
      <span class="hamburger-line hamburger-line--top"></span>
      <span class="hamburger-line hamburger-line--middle"></span>
      <span class="hamburger-line hamburger-line--bottom"></span>
    </span>
  </button>

  <!-- Sidebar -->
  <aside class="patient-shell__sidebar" [class.open]="sidebarOpen">
    <!-- Close Button -->
    <button class="close-sidebar-btn" (click)="closeSidebar()">
      <i class="bi bi-x-lg"></i>
    </button>

    <!-- Brand Header -->
    <div class="patient-shell__brand" (click)="navigate('/')" title="Back to Home">
      <div class="brand-header">
        <div class="brand-logo-wrapper">
          <img src="assets/images/QuickMed-Logo-Light.png" alt="QuickMed Logo" />
        </div>
        <div class="brand-portal-badge">
          <span class="portal-dot"></span>
          <span class="portal-text">Patient Portal</span>
        </div>
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Navigation -->
    <nav class="patient-shell__nav">
      <a *ngFor="let item of menuItems" class="patient-shell__nav-item" [routerLink]="item.route"
        routerLinkActive="active" [routerLinkActiveOptions]="{ exact: item.exact !== false }" (click)="closeSidebar()">
        <div class="nav-icon-wrapper">
          <i class="bi" [ngClass]="item.icon"></i>
        </div>
        <span>{{ item.label }}</span>
      </a>
    </nav>

    <div class="sidebar-divider"></div>

    <!-- Profile Card -->
    <div class="patient-shell__profile" *ngIf="user as current">
      <div class="profile-card">
        <div class="avatar">
          <img *ngIf="current.avatar; else initials" [src]="current.avatar" alt="{{ current.firstName }}" />
          <ng-template #initials>
            {{ (current.firstName.charAt(0) || 'A') + (current.lastName.charAt(0) || 'J') }}
          </ng-template>
          <span class="avatar-status-dot"></span>
        </div>
        <div class="profile-info">
          <p class="profile-name">{{ current.firstName }} {{ current.lastName }}</p>
          <p class="profile-id">{{ current.patientId || 'QM-' + current.id.substring(0,8) }}</p>
        </div>
        <button class="profile-logout-btn" type="button" (click)="logout(); closeSidebar()" title="Logout">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="patient-shell__content">
    <div class="patient-shell__topbar">
      <!-- Messages -->
      <div class="relative">
        <button class="patient-shell__icon-btn" type="button" title="Messages" (click)="toggleMessages($event)">
          <i class="bi bi-chat-dots-fill"></i>
          <span class="patient-shell__badge badge-blue" *ngIf="unreadMessages() > 0">{{ unreadMessages() }}</span>
        </button>

        <div class="dropdown-panel messages-dropdown" *ngIf="messagesOpen()" (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <h3>Recent Messages</h3>
            <button class="view-all" (click)="navigate('/patient/messages')">Open Chat</button>
          </div>
          <div class="dropdown-body custom-scrollbar" *ngIf="!isLoadingMessages(); else messagesLoading">
            <button *ngFor="let conv of conversations()" class="dropdown-item message-item"
              (click)="openConversation(conv, $event)">
              <div class="item-avatar">
                <img *ngIf="conv.doctor?.avatar; else doctorInitials" [src]="conv.doctor?.avatar"
                  [alt]="conv.doctor?.firstName">
                <ng-template #doctorInitials>
                  {{ (conv.doctor?.firstName || 'D').charAt(0) }}
                </ng-template>
              </div>
              <div class="item-content">
                <div class="item-row">
                  <p class="item-title">Dr. {{ conv.doctor?.firstName }} {{ conv.doctor?.lastName }}</p>
                  <span class="item-time" *ngIf="conv.lastMessageAt">{{ formatNotificationTime(conv.lastMessageAt)
                    }}</span>
                </div>
                <p class="item-preview" [class.unread-text]="conv.unreadCount > 0">
                  {{ conv.lastMessageContent || 'No messages yet' }}
                </p>
                <div class="unread-dot" *ngIf="conv.unreadCount > 0"></div>
              </div>
            </button>
            <div class="empty-state" *ngIf="conversations().length === 0">
              <i class="bi bi-chat-left-text"></i>
              <p>No conversations yet</p>
            </div>
          </div>
          <ng-template #messagesLoading>
            <div class="dropdown-loading">
              <div class="dots-loader"></div>
            </div>
          </ng-template>
          <div class="dropdown-footer">
            <button (click)="navigate('/patient/messages')">View All Conversations</button>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="relative">
        <button class="patient-shell__icon-btn" type="button" title="Notifications"
          (click)="toggleNotifications($event)">
          <i class="bi bi-bell-fill"></i>
          <span class="patient-shell__badge bg-rose-500" *ngIf="unreadNotifications() > 0">{{ unreadNotifications()
            }}</span>
        </button>

        <div class="dropdown-panel notifications-dropdown" *ngIf="notificationsOpen()"
          (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <h3>Notifications</h3>
            <button class="mark-all-btn" (click)="markAllNotificationsRead($event)"
              [disabled]="unreadNotifications() === 0">
              Mark all read
            </button>
          </div>
          <div class="dropdown-body custom-scrollbar" *ngIf="!isLoadingNotifications(); else notificationsLoading">
            <button *ngFor="let note of notifications()" class="dropdown-item notification-item"
              [class.unread]="!note.read" (click)="openNotification(note, $event)">
              <div class="item-icon-wrapper" [class]="notificationService.getPriorityColorClass(note.priority)">
                <i class="bi" [ngClass]="notificationService.getNotificationIcon(note.type)"></i>
              </div>
              <div class="item-content">
                <div class="item-row">
                  <p class="item-title">{{ note.title }}</p>
                  <span class="item-time">{{ formatNotificationTime(note.createdAt) }}</span>
                </div>
                <p class="item-description">{{ note.message }}</p>
              </div>
            </button>
            <div class="empty-state" *ngIf="notifications().length === 0">
              <p>You're all caught up!</p>
            </div>
          </div>
          <ng-template #notificationsLoading>
            <div class="dropdown-loading">
              <div class="dots-loader"></div>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Theme Toggle -->
      <button class="patient-shell__icon-btn theme-toggle" type="button" (click)="toggleTheme()" title="Toggle theme">
        <i class="bi" [ngClass]="themeService.isDarkMode() ? 'bi-moon-stars-fill' : 'bi-brightness-high-fill'"></i>
      </button>
    </div>

    <ng-content></ng-content>
  </main>
</div>