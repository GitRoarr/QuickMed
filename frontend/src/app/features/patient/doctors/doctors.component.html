<app-patient-shell active="doctors">
  <div class="doctors-page">
    <div class="page-header">
      <div>
        <p class="eyebrow">Find Doctors</p>
        <h1>Browse and book appointments with our healthcare professionals</h1>
      </div>
    </div>

    <div class="search-controls">
      <div class="search-input">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Search by name, specialty, or expertise..." [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()" />
      </div>
      <div class="filter-select">
        <label>Specialty</label>
        <select [(ngModel)]="selectedSpecialty" (ngModelChange)="onSpecialtyChange()">
          <option *ngFor="let specialty of specialties" [value]="specialty.value">
            {{ specialty.label }}
          </option>
        </select>
      </div>
    </div>

    <div class="results-note" *ngIf="!isLoading()">
      Found {{ filteredDoctors().length }} doctors
    </div>

    <div class="doctors-grid" *ngIf="!isLoading(); else loadingState">
      <div class="doctor-card" *ngFor="let doctor of filteredDoctors()">
        <div class="card-head">
          <div class="avatar">
            <ng-container *ngIf="doctor.avatar; else doctorInitial">
              <img [src]="doctor.avatar" alt="Dr. {{ doctor.firstName }} {{ doctor.lastName }}" />
            </ng-container>
            <ng-template #doctorInitial>
              {{ ((doctor.firstName || '').charAt(0) || 'D') + (doctor.lastName || '').charAt(0) }}
            </ng-template>
          </div>
          <span class="availability" [class.available]="doctor.available">
            {{ doctor.available ? 'Available Today' : (doctor.nextAvailableDate ? ('Next: ' + (doctor.nextAvailableDate
            | date:'MMM d')) : 'Unavailable') }}
          </span>
        </div>

        <div class="card-body">
          <h3>Dr. {{ doctor.firstName }} {{ doctor.lastName }}</h3>

          <div class="tag-row">
            <span class="tag">{{ doctor.specialty || 'General' }}</span>
            <span class="tag ghost">{{ doctor.experience || 0 }}+ yrs</span>
            <span class="tag ghost" *ngIf="doctor.nextAvailableDate">Next: {{ doctor.nextAvailableDate | date:'EEE, MMM
              d' }}</span>
          </div>

          <div class="rating">
            <span *ngFor="let star of getStarArray(doctor.rating || 0)" class="star" [class.filled]="star === 1">
              <i class="bi" [class.bi-star-fill]="star === 1" [class.bi-star]="star === 0"></i>
            </span>
            <span class="rating-text">
              {{ doctor.rating || 0 }} ({{ doctor.ratingCount || 0 }})
            </span>
          </div>

          <p class="bio">{{ doctor.bio }}</p>

          <div class="contact-row">
            <span><i class="bi bi-telephone"></i>{{ doctor.phoneNumber || 'â€”' }}</span>
            <span><i class="bi bi-envelope"></i>{{ doctor.email }}</span>
          </div>
        </div>

        <div class="card-actions">
          <button class="primary-btn subtle" (click)="selectDoctor(doctor)" [disabled]="!doctor.available">
            <i class="bi bi-calendar-plus"></i>
            {{ doctor.available ? 'Book Appointment' : 'Unavailable' }}
          </button>
          <button class="ghost-btn" type="button" (click)="openRating(doctor)">
            <i class="bi bi-star"></i>
            Rate doctor
          </button>
        </div>
      </div>

      <div class="empty-state" *ngIf="filteredDoctors().length === 0">
        <i class="bi bi-search"></i>
        <p>No doctors match your filters.</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showBookingForm()" (click)="closeBookingForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Book Appointment</h2>
        <button class="icon-btn" (click)="closeBookingForm()"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body" *ngIf="selectedDoctor()">
        <div class="doctor-summary">
          <div class="avatar small">
            <ng-container *ngIf="selectedDoctor()?.avatar; else selectedInitial">
              <img [src]="selectedDoctor()?.avatar!"
                alt="Dr. {{ selectedDoctor()?.firstName }} {{ selectedDoctor()?.lastName }}" />
            </ng-container>
            <ng-template #selectedInitial>{{ getSelectedDoctorInitial() }}</ng-template>
          </div>
          <div>
            <p class="doctor-name">Dr. {{ selectedDoctor()?.firstName }} {{ selectedDoctor()?.lastName }}</p>
            <p class="muted">{{ selectedDoctor()?.specialty }}</p>
          </div>
        </div>

        <form [formGroup]="appointmentForm" (ngSubmit)="bookAppointment()">
          <label>
            <span>Appointment Date</span>
            <input type="date" formControlName="appointmentDate" [min]="getCurrentDate()" (change)="onDateChange()" />
          </label>

          <label class="mt-4">
            <span class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 block">Available Time
              Slots</span>
            <div class="slot-selector" *ngIf="availableSlots().length > 0; else noSlots">
              <div class="custom-select-wrapper">
                <i class="bi bi-clock select-icon"></i>
                <select class="time-select-compact" formControlName="appointmentTime" (change)="manualTimeInput = ''">
                  <option value="" disabled>Choose an available time slot</option>

                  <optgroup label="ðŸŒ… MORNING" *ngIf="morningSlots().length > 0">
                    <option *ngFor="let slot of morningSlots()" [value]="slot.startTime">
                      {{ formatSlotTime(slot) }}
                    </option>
                  </optgroup>

                  <optgroup label="â˜€ï¸ AFTERNOON" *ngIf="afternoonSlots().length > 0">
                    <option *ngFor="let slot of afternoonSlots()" [value]="slot.startTime">
                      {{ formatSlotTime(slot) }}
                    </option>
                  </optgroup>

                  <optgroup label="ðŸŒ™ EVENING" *ngIf="eveningSlots().length > 0">
                    <option *ngFor="let slot of eveningSlots()" [value]="slot.startTime">
                      {{ formatSlotTime(slot) }}
                    </option>
                  </optgroup>
                </select>
                <i class="bi bi-chevron-down dropdown-arrow"></i>
              </div>

              <div class="or-divider">
                <span>OR</span>
              </div>

              <div class="manual-time-picker">
                <div class="manual-picker-content">
                  <i class="bi bi-keyboard-fill"></i>
                  <div class="flex-1">
                    <span class="manual-label">Enter Custom Time</span>
                    <input type="time" class="time-input-compact" [(ngModel)]="manualTimeInput"
                      [ngModelOptions]="{standalone: true}" (change)="onManualTimeChange()" placeholder="HH:MM" />
                  </div>
                </div>
                <p class="time-helper-text">Select a time within the doctor's active hours</p>
              </div>

              <input type="hidden" formControlName="appointmentTime" />
            </div>
            <ng-template #noSlots>
              <div class="no-slots-message">
                <p *ngIf="appointmentForm.value.appointmentDate">No available slots for this date. Please select another
                  date.</p>
                <p *ngIf="nextAvailableDate()">Next available date: {{ nextAvailableDate() }}</p>
                <p *ngIf="!appointmentForm.value.appointmentDate">Please select a date to see available time slots.</p>
              </div>
            </ng-template>
          </label>

          <label>
            <span>Notes (optional)</span>
            <textarea rows="3" formControlName="notes" placeholder="Add special requests..."></textarea>
          </label>

          <div class="modal-actions">
            <button type="button" class="text-btn" (click)="closeBookingForm()">Cancel</button>
            <button type="submit" class="primary-btn"
              [disabled]="appointmentForm.invalid || !appointmentForm.value.appointmentTime">
              <i class="bi bi-check-circle"></i>
              Confirm Booking
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="ratingDoctor()" (click)="closeRating()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Rate Doctor</h2>
        <button class="icon-btn" (click)="closeRating()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="modal-body" *ngIf="ratingDoctor() as rd">
        <p class="mb-3">How was your experience with Dr. {{ rd.firstName }} {{ rd.lastName }}?</p>
        <div class="rating-input">
          <button type="button" *ngFor="let star of [1,2,3,4,5]" class="star-btn" [class.active]="star <= ratingValue()"
            (click)="setRating(star)">
            <i class="bi" [ngClass]="star <= ratingValue() ? 'bi-star-fill' : 'bi-star'"></i>
          </button>
        </div>
        <div class="modal-actions">
          <button type="button" class="text-btn" (click)="closeRating()">Cancel</button>
          <button type="button" class="primary-btn" [disabled]="ratingValue() === 0 || ratingSubmitting()"
            (click)="submitRating()">
            Submit rating
          </button>
        </div>
      </div>
    </div>
  </div>
</app-patient-shell>

<ng-template #loadingState>
  <div class="empty-state">
    <div class="spinner"></div>
    Loading doctors...
  </div>
</ng-template>