<app-sidebar title="QuickMed Admin Portal" [menuItems]="menuItems"></app-sidebar>

<div class="ml-60 bg-gray-50 min-h-screen">
  <!-- Enhanced Header with Notifications -->
  <div class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center gap-8">
    <div class="flex-1 max-w-md">
      <input 
        type="text" 
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        placeholder="Search patients, doctors, appointments..." 
        class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm text-gray-700 placeholder-gray-500">
    </div>
    <div class="flex items-center gap-6">
      <!-- Notification Icon with Dropdown -->
      <div class="relative notification-icon">
        <button 
          (click)="toggleNotificationDropdown()"
          class="relative w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-sm text-gray-600 cursor-pointer hover:bg-gray-200 transition">
          <i class="bi bi-bell text-lg"></i>
          <span 
            *ngIf="unreadCount() > 0"
            class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white text-white text-xs flex items-center justify-center font-bold">
            {{ unreadCount() > 9 ? '9+' : unreadCount() }}
          </span>
        </button>
        
        <!-- Notification Dropdown -->
        <div 
          *ngIf="showNotificationDropdown()"
          class="notification-dropdown absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50 max-h-96 overflow-hidden flex flex-col">
          <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="font-semibold text-gray-900">Notifications</h3>
            <div class="flex gap-2">
              <button 
                *ngIf="unreadCount() > 0"
                (click)="markAllAsRead()"
                class="text-xs text-blue-600 hover:text-blue-800">
                Mark all as read
              </button>
              <button 
                (click)="showNotificationDropdown.set(false)"
                class="text-gray-400 hover:text-gray-600">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>
          
          <div class="overflow-y-auto flex-1">
            <div *ngIf="isLoadingNotifications()" class="p-4 text-center text-gray-500">
              Loading notifications...
            </div>
            <div *ngIf="!isLoadingNotifications() && notifications().length === 0" class="p-4 text-center text-gray-500">
              No notifications
            </div>
            <div *ngIf="!isLoadingNotifications() && notifications().length > 0" class="divide-y divide-gray-200">
              <div 
                *ngFor="let notification of notifications()"
                [class.bg-blue-50]="!notification.read"
                class="p-4 hover:bg-gray-50 cursor-pointer transition"
                (click)="markAsRead(notification.id)">
                <div class="flex items-start gap-3">
                  <div [class]="'w-8 h-8 rounded-full flex items-center justify-center ' + (notification.read ? 'bg-gray-200' : 'bg-blue-100')">
                    <i [class]="'bi ' + notificationService.getNotificationIcon(notification.type) + ' ' + (notification.read ? 'text-gray-600' : 'text-blue-600')"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p [class]="'text-sm font-medium ' + (notification.read ? 'text-gray-600' : 'text-gray-900')">
                      {{ notification.title }}
                    </p>
                    <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ notification.message }}</p>
                    <p class="text-xs text-gray-400 mt-1">{{ notification.createdAt | date:'short' }}</p>
                  </div>
                  <span *ngIf="!notification.read" class="w-2 h-2 bg-blue-600 rounded-full flex-shrink-0 mt-2"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- New Appointment Button with Icon -->
      <button 
        (click)="openNewAppointmentModal(newAppointmentModal)" 
        class="px-4 py-2 text-white rounded-lg font-semibold transition flex items-center gap-2"
        [style.background-color]="themeService.currentTheme()?.primaryColor || '#10b981'"
        (mouseenter)="onButtonHover($event, true)"
        (mouseleave)="onButtonHover($event, false)">
        <i class="bi bi-plus-circle"></i>
        <span>New Appointment</span>
      </button>
    </div>
  </div>

  <div class="p-8 max-w-7xl">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900">All Appointments</h2>
      <button 
        (click)="openNewAppointmentModal(newAppointmentModal)" 
        class="px-4 py-2 text-white rounded-lg font-semibold transition"
        [style.background-color]="themeService.currentTheme()?.primaryColor || '#10b981'"
        (mouseenter)="onButtonHover($event, true)"
        (mouseleave)="onButtonHover($event, false)">
        New Appointment
      </button>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-lg font-bold text-gray-900">All Appointments</h3>
          <p class="text-sm text-gray-600">{{ filteredAppointments().length }} of {{ totalAppointments() }} appointments</p>
        </div>
        <div class="flex gap-4 items-center">
          <button 
            (click)="toggleViewMode()"
            class="px-3 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
            <i [class]="viewMode() === 'list' ? 'bi bi-calendar' : 'bi bi-list'"></i>
            <span>{{ viewMode() === 'list' ? 'Calendar View' : 'List View' }}</span>
          </button>
          <button 
            (click)="openCalendarView(calendarModal)"
            class="px-3 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
            <i class="bi bi-calendar3"></i>
            <span>View Calendar</span>
          </button>
        </div>
      </div>

      <!-- Advanced Filters -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Status Filter -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
            <select 
              [(ngModel)]="selectedStatus" 
              (ngModelChange)="onStatusChange()"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <!-- Date Filter -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Date</label>
            <input 
              type="date" 
              [(ngModel)]="selectedDate"
              (ngModelChange)="onDateChange()"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
          </div>

          <!-- Doctor Filter -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Doctor</label>
            <select 
              [(ngModel)]="selectedDoctor"
              (ngModelChange)="onDoctorChange()"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              <option value="all">All Doctors</option>
              <option *ngFor="let doctor of doctors()" [value]="doctor.id">
                Dr. {{ doctor.firstName }} {{ doctor.lastName }}
              </option>
            </select>
          </div>

          <!-- Patient Filter -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Patient</label>
            <select 
              [(ngModel)]="selectedPatient"
              (ngModelChange)="onPatientChange()"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              <option value="all">All Patients</option>
              <option *ngFor="let patient of patients()" [value]="patient.id">
                {{ patient.firstName }} {{ patient.lastName }}
              </option>
            </select>
          </div>
        </div>
        
        <!-- Clear Filters -->
        <div class="mt-3 flex justify-end">
          <button 
            (click)="clearFilters()"
            class="text-xs text-gray-600 hover:text-gray-900 underline">
            Clear all filters
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading()" class="text-center py-8">
        <p class="text-gray-500">Loading appointments...</p>
      </div>

      <!-- Appointments List View -->
      <div *ngIf="!isLoading() && viewMode() === 'list'" class="space-y-3">
        <div 
          *ngFor="let appointment of filteredAppointments()" 
          class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:shadow-md transition">
          <div class="flex-1">
            <div class="font-semibold text-gray-900">{{ getPatientName(appointment) }}</div>
            <div class="text-sm text-gray-600">{{ getAppointmentType(appointment) }}</div>
            <div class="flex gap-2 text-xs text-gray-600 mt-1">
              <span>{{ appointment.isVideoConsultation ? 'üìπ Video Call' : 'üìç In-Person' }}</span>
              <span>‚Ä¢</span>
              <span>{{ getDoctorName(appointment) }}</span>
              <span *ngIf="appointment.location">‚Ä¢</span>
              <span *ngIf="appointment.location">{{ appointment.location }}</span>
            </div>
          </div>
          <span [ngClass]="getStatusClass(appointment.status)" [style.background-color]="getStatusColor(appointment.status)">{{ appointment.status }}</span>
          <div class="text-right ml-6">
            <div class="font-semibold text-gray-900">{{ formatTime(appointment.appointmentTime) }}</div>
            <div class="text-xs text-gray-600">{{ formatDate(appointment.appointmentDate) }}</div>
          </div>
          <button class="ml-4 text-gray-400 hover:text-gray-600">‚ãÆ</button>
        </div>

        <!-- Empty State -->
        <div *ngIf="filteredAppointments().length === 0" class="text-center py-8">
          <i class="bi bi-calendar-x text-4xl text-gray-400 mb-2"></i>
          <p class="text-gray-500">No appointments found</p>
          <p class="text-sm text-gray-400 mt-1">Try adjusting your filters</p>
        </div>
      </div>

      <!-- Calendar View -->
      <div *ngIf="!isLoading() && viewMode() === 'calendar'" class="calendar-view">
        <div class="grid grid-cols-7 gap-2">
          <!-- Calendar Header -->
          <div *ngFor="let day of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']" 
               class="text-center font-semibold text-gray-700 py-2">
            {{ day }}
          </div>
          
          <!-- Calendar Days -->
          <div 
            *ngFor="let day of getCalendarDays()"
            [class.bg-blue-50]="day.hasAppointments"
            [class.border-blue-300]="day.hasAppointments"
            class="min-h-24 p-2 border border-gray-200 rounded-lg">
            <div class="text-sm font-medium text-gray-700 mb-1">{{ day.date.getDate() }}</div>
            <div class="space-y-1">
              <div 
                *ngFor="let apt of day.appointments"
                [style.background-color]="getStatusColor(apt.status)"
                class="text-xs text-white p-1 rounded truncate cursor-pointer hover:opacity-80"
                [title]="getPatientName(apt) + ' - ' + formatTime(apt.appointmentTime)">
                {{ formatTime(apt.appointmentTime) }} - {{ getPatientName(apt).split(' ')[0] }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calendar Modal -->
<ng-template #calendarModal let-modal>
  <div class="modal-header">
    <h3 class="text-lg font-semibold text-gray-900">Calendar View</h3>
    <button type="button" class="text-gray-400 hover:text-gray-600" (click)="modal.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="calendar-view-large">
      <!-- Similar calendar view but larger -->
      <div class="grid grid-cols-7 gap-2">
        <div *ngFor="let day of getCalendarDays()" 
             [class.bg-blue-50]="day.hasAppointments"
             class="min-h-32 p-2 border border-gray-200 rounded-lg">
          <div class="text-sm font-medium text-gray-700 mb-2">{{ day.date.getDate() }}</div>
          <div class="space-y-1">
            <div *ngFor="let apt of day.appointments"
                 [style.background-color]="getStatusColor(apt.status)"
                 class="text-xs text-white p-2 rounded cursor-pointer hover:opacity-80">
              <div class="font-semibold">{{ formatTime(apt.appointmentTime) }}</div>
              <div>{{ getPatientName(apt) }}</div>
              <div class="text-xs opacity-90">{{ getDoctorName(apt) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- New Appointment Modal -->
<ng-template #newAppointmentModal let-modal>
  <div class="modal-header">
    <h3 class="text-lg font-semibold text-gray-900">New Appointment</h3>
    <button type="button" class="text-gray-400 hover:text-gray-600" (click)="modal.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <!-- Alert Message -->
    <div *ngIf="alertMessage()" 
         [ngClass]="alertMessage()?.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
         class="p-3 rounded-lg mb-4">
      {{ alertMessage()?.text }}
    </div>

    <form (ngSubmit)="createAppointment()">
      <div class="grid grid-cols-2 gap-4">
        <!-- Patient Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Patient *</label>
          <select 
            [(ngModel)]="newAppointment().patientId"
            name="patientId"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            required>
            <option value="">Select patient</option>
            <option *ngFor="let patient of patients()" [value]="patient.id">
              {{ patient.firstName }} {{ patient.lastName }} ‚Äî {{ patient.email }}
            </option>
          </select>
        </div>

        <!-- Doctor Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Doctor *</label>
          <select 
            [(ngModel)]="newAppointment().doctorId"
            name="doctorId"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            required>
            <option value="">Select doctor</option>
            <option *ngFor="let doctor of doctors()" [value]="doctor.id">
              Dr. {{ doctor.firstName }} {{ doctor.lastName }} ‚Äî {{ doctor.specialty || 'Doctor' }}
            </option>
          </select>
        </div>

        <!-- Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
          <input 
            type="date" 
            [(ngModel)]="newAppointment().appointmentDate"
            name="appointmentDate"
            [min]="getMinDate()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            required>
        </div>

        <!-- Time -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Time *</label>
          <input 
            type="time" 
            [(ngModel)]="newAppointment().appointmentTime"
            name="appointmentTime"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            required>
        </div>

        <!-- Appointment Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Appointment Type</label>
          <select 
            [(ngModel)]="newAppointment().appointmentType"
            name="appointmentType"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
            <option *ngFor="let type of appointmentTypes" [value]="type">{{ type }}</option>
          </select>
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select 
            [(ngModel)]="newAppointment().status"
            name="status"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <!-- Reason -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
          <input 
            type="text" 
            [(ngModel)]="newAppointment().reason"
            name="reason"
            placeholder="e.g., Annual Checkup, Follow-up"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
          <input 
            type="text" 
            [(ngModel)]="newAppointment().location"
            name="location"
            placeholder="e.g., Room 101"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
        </div>

        <!-- Video Consultation -->
        <div class="col-span-2">
          <label class="flex items-center">
            <input 
              type="checkbox" 
              [(ngModel)]="newAppointment().isVideoConsultation"
              name="isVideoConsultation"
              class="mr-2">
            <span class="text-sm font-medium text-gray-700">Video Consultation</span>
          </label>
        </div>

        <!-- Notes -->
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
          <textarea 
            [(ngModel)]="newAppointment().notes"
            name="notes"
            rows="3"
            placeholder="Additional notes..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
        </div>
      </div>

      <div class="modal-footer mt-6 flex justify-end gap-3">
        <button 
          type="button" 
          (click)="modal.dismiss()"
          class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Cancel
        </button>
        <button 
          type="submit"
          class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
          Create Appointment
        </button>
      </div>
    </form>
  </div>
</ng-template>
