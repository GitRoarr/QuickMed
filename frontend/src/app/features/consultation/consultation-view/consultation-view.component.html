@if (loading()) {
<div class="consultation-view p-4 md:p-8 animate-pulse">
  <div class="max-w-5xl mx-auto space-y-6">
    <div class="h-10 bg-gray-200 dark:bg-gray-800 rounded-xl w-1/4"></div>
    <div class="h-64 bg-gray-200 dark:bg-gray-800 rounded-3xl"></div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-2xl"></div>
      <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-2xl"></div>
      <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-2xl"></div>
    </div>
  </div>
</div>
}

@if (!loading() && consultation()) {
<div class="consultation-view p-4 md:p-8">
  <div class="max-w-5xl mx-auto space-y-8">

    <!-- Top Bar -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <button (click)="goBack()" class="back-btn mb-4">
          <i class="bi bi-arrow-left"></i>
          Back to Appointments
        </button>
        <h1 class="page-title text-3xl font-extrabold text-gray-900 dark:text-white">
          Medical Consultation Report
        </h1>
        <p class="text-gray-500 dark:text-gray-400">Reference ID: {{ consultation()?.id?.slice(0, 8) }} â€¢ {{
          formatDate(consultation()?.createdAt) }}</p>
      </div>
      <div class="action-group">
        <button onclick="window.print()" class="print-btn">
          <i class="bi bi-printer"></i>
          Print Report
        </button>
        <button class="share-btn">
          <i class="bi bi-share"></i>
        </button>
      </div>
    </div>

    <!-- Main Report Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Left Column: Core Info & Vitals -->
      <div class="lg:col-span-2 space-y-8">

        <!-- Summary Card -->
        <div class="report-card primary-gradient overflow-hidden">
          <div
            class="card-inner flex flex-col md:flex-row gap-8 p-8 items-center md:items-start text-center md:text-left">
            <div class="doctor-badge-large">
              <img [src]="consultation()?.doctor?.avatar" alt="Dr"
                onerror="this.src='https://ui-avatars.com/api/?name=Dr+'+consultation()?.doctor?.fullName+'&background=fff&color=10b981&size=128'"
                class="avatar-img">
              <div class="verified-icon"><i class="bi bi-patch-check-fill"></i></div>
            </div>
            <div class="flex-1 space-y-4">
              <div>
                <h2 class="text-2xl font-bold text-white">Dr. {{ consultation()?.doctor?.fullName }}</h2>
                <p class="text-white/80 text-lg">{{ consultation()?.doctor?.specialization || 'Consulting Physician' }}
                </p>
              </div>
              <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                <div class="meta-pill">
                  <i class="bi bi-calendar-check"></i>
                  {{ consultation()?.appointment?.appointmentDate | date:'fullDate' }}
                </div>
                <div class="meta-pill">
                  <i class="bi bi-clock-history"></i>
                  {{ consultation()?.durationMin || 30 }} Minutes Session
                </div>
              </div>
            </div>
            <div class="session-type-badge">
              <i class="bi"
                [ngClass]="consultation()?.appointment?.isVideoConsultation ? 'bi-camera-video-fill' : 'bi-house-heart-fill'"></i>
              <span>{{ consultation()?.appointment?.isVideoConsultation ? 'Virtual Visit' : 'Clinic Visit' }}</span>
            </div>
          </div>
        </div>

        <!-- Clinical Notes -->
        <div class="report-card">
          <div class="card-header">
            <h3 class="flex items-center gap-2 text-xl font-bold">
              <i class="bi bi-file-earmark-medical text-primary"></i>
              Post-Consultation Notes
            </h3>
          </div>
          <div class="p-8">
            <div class="prose dark:prose-invert max-w-none">
              <div
                class="rich-content bg-gray-50 dark:bg-gray-800/50 p-6 rounded-2xl border border-dashed border-gray-200 dark:border-gray-700">
                <p class="whitespace-pre-wrap leading-relaxed text-lg">{{ consultation()?.notes || 'General consultation
                  completed. No specific clinical notes provided.' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Treatment & Prescription -->
        @if (consultation()?.treatments && consultation()!.treatments.length > 0) {
        <div class="report-card prescription-skin">
          <div class="card-header flex justify-between items-center">
            <h3 class="flex items-center gap-2 text-xl font-bold">
              <i class="bi bi-prescription text-rose-500"></i>
              Treatment Plan & RX
            </h3>
            <span class="count-badge">{{ consultation()!.treatments.length }} Items</span>
          </div>
          <div class="p-0">
            @for (treatment of consultation()!.treatments; track treatment.id || $index) {
            <div
              class="treatment-item p-8 border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50/50 dark:hover:bg-gray-800/20 transition-all">
              <div class="flex gap-6 items-start">
                <div class="tm-icon" [ngClass]="treatment.type">
                  <i class="bi" [ngClass]="{
                    'bi-capsule': treatment.type === 'medication',
                    'bi-activity': treatment.type === 'therapy',
                    'bi-bandaid': treatment.type === 'procedure',
                    'bi-droplet-half': treatment.type === 'lab_test'
                  }"></i>
                </div>
                <div class="flex-1">
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-3">
                    <h4 class="text-xl font-bold text-gray-900 dark:text-white capitalize">{{ treatment.details }}</h4>
                    <span class="type-tag" [ngClass]="treatment.type">{{ treatment.type.replace('_', ' ') }}</span>
                  </div>
                  @if (treatment.instructions) {
                  <div class="instruction-box">
                    <label>Instructions</label>
                    <p>{{ treatment.instructions }}</p>
                  </div>
                  }
                  <div class="mt-4 flex items-center gap-4 text-sm text-gray-500">
                    @if (treatment.administered) {
                    <span class="flex items-center gap-1 text-emerald-600 font-bold">
                      <i class="bi bi-check-circle-fill"></i> Completed
                    </span>
                    } @else {
                    <span class="flex items-center gap-1 text-amber-600 font-bold">
                      <i class="bi bi-clock-fill"></i> Scheduled
                    </span>
                    }
                  </div>
                </div>
              </div>
            </div>
            }
          </div>
        </div>
        }

      </div>

      <!-- Right Column: Sidebar Stats & Feedback -->
      <div class="space-y-8">

        <!-- Quick Stats -->
        <div class="report-card p-6 space-y-6">
          <h3 class="font-bold text-gray-900 dark:text-white border-b border-gray-100 dark:border-gray-800 pb-4">Session
            Stats</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="stat-box">
              <label>Quality</label>
              <div class="val text-amber-500">
                <i class="bi bi-star-fill"></i>
                {{ consultation()?.rating || 'N/A' }}
              </div>
            </div>
            <div class="stat-box">
              <label>Duration</label>
              <div class="val">{{ consultation()?.durationMin || 30 }}m</div>
            </div>
          </div>
        </div>

        <!-- Feedback Card -->
        @if (consultation()?.comment) {
        <div
          class="report-card feedback-card bg-amber-50/50 dark:bg-amber-900/10 border-amber-100 dark:border-amber-900/30">
          <div class="p-6">
            <h3 class="flex items-center gap-2 font-bold text-amber-800 dark:text-amber-400 mb-4">
              <i class="bi bi-chat-heart"></i>
              My Experience
            </h3>
            <p class="text-amber-700 dark:text-amber-300 italic">"{{ consultation()?.comment }}"</p>
          </div>
        </div>
        }

        <!-- Next Steps / Advice -->
        <div class="report-card p-6 bg-primary/5 border-primary/10">
          <h3 class="font-bold text-primary mb-4">Doctor's Advice</h3>
          <ul class="space-y-3">
            <li class="flex gap-3 text-sm">
              <i class="bi bi-check2-circle text-primary"></i>
              Follow prescription as directed
            </li>
            <li class="flex gap-3 text-sm">
              <i class="bi bi-check2-circle text-primary"></i>
              Keep records for next follow-up
            </li>
            <li class="flex gap-3 text-sm">
              <i class="bi bi-check2-circle text-primary"></i>
              Contact doctor if symptoms persist
            </li>
          </ul>
        </div>

        <!-- Contact Support -->
        <div class="report-card p-6 text-center space-y-4">
          <div class="w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto">
            <i class="bi bi-question-circle text-gray-500"></i>
          </div>
          <p class="text-sm text-gray-500">Have questions about this report?</p>
          <button
            class="w-full py-2 px-4 rounded-xl border border-gray-200 dark:border-gray-700 font-bold hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            Ask Questions
          </button>
        </div>

      </div>

    </div>

    <!-- Print Footer (Visible only when printing) -->
    <div class="print-only-footer mt-12 pt-8 border-t border-gray-200 text-center text-gray-400 text-sm">
      <p>This is a computer-generated medical document from QuickMed Platform.</p>
      <p>Consultation Date: {{ consultation()?.createdAt | date:'medium' }}</p>
    </div>

  </div>
</div>
}

@if (!loading() && !consultation()) {
<div class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6">
  <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center text-4xl">
    ðŸ§ª
  </div>
  <div>
    <h2 class="text-2xl font-bold">No Consultation Records</h2>
    <p class="text-gray-500 max-w-md mx-auto mt-2">We couldn't find the details for this consultation. It might still be
      processing or was removed.</p>
  </div>
  <button (click)="goBack()"
    class="px-8 py-3 bg-primary text-white font-bold rounded-2xl shadow-xl shadow-primary/20 hover:scale-105 transition-all">
    Return to Appointments
  </button>
</div>
}