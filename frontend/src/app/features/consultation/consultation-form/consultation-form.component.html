<!-- Loading State -->
<div *ngIf="isLoading()" class="consultation-container qm-page">
  <div class="qm-card" style="background:none;border:none;box-shadow:none;margin-top:0;">
    <h1 class="qm-page-title">New Consultation</h1>
    <p class="qm-page-subtitle">Loading appointment data...</p>
  </div>
  <div class="qm-card" style="padding:60px 20px;text-align:center;">
    <div class="qm-spinner-lg"></div>
  </div>
</div>

<!-- Main Form â€” Everything inside [formGroup] -->
<form *ngIf="!isLoading()" [formGroup]="consultationForm" (ngSubmit)="onSubmit()"
  class="consultation-container qm-page">

  <!-- Page Title -->
  <div class="qm-card" style="background:none;border:none;box-shadow:none;margin-top:0;">
    <h1 class="qm-page-title">New Consultation</h1>
    <p class="qm-page-subtitle">Record consultation notes and treatments</p>
  </div>

  <!-- Patient & Appointment Info Card -->
  <div class="qm-card">
    <div class="qm-patient-banner">
      <div class="qm-patient-avatar">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      </div>
      <div>
        <p class="qm-patient-label">Patient</p>
        <p class="qm-patient-name">
          {{ patient()?.firstName && patient()?.lastName
          ? (patient()?.firstName + ' ' + patient()?.lastName)
          : 'Unknown' }}
        </p>
        <ng-container *ngIf="patient() as p">
          <p class="qm-patient-email" *ngIf="p.email; else noEmail">
            {{ p.email.split('@')[0] + '&#64;' + p.email.split('@')[1] }}
          </p>
          <ng-template #noEmail>
            <p class="qm-patient-email">N/A</p>
          </ng-template>
        </ng-container>
      </div>
    </div>
    <div class="qm-meta-grid">
      <div>
        <p class="qm-meta-label">Date</p>
        <p class="qm-meta-value">{{ appointment()?.appointmentDate | date:'mediumDate' }}</p>
      </div>
      <div>
        <p class="qm-meta-label">Time</p>
        <p class="qm-meta-value">{{ appointment()?.appointmentTime || 'N/A' }}</p>
      </div>
      <div>
        <p class="qm-meta-label">Type</p>
        <p class="qm-meta-value">{{ appointment()?.appointmentType || 'N/A' }}</p>
      </div>
      <div>
        <p class="qm-meta-label">Status</p>
        <span class="qm-badge">{{ appointment()?.status || 'N/A' }}</span>
      </div>
    </div>
  </div>

  <!-- Clinical Notes -->
  <div class="qm-card">
    <div class="qm-section-header">
      <div class="qm-section-left">
        <div class="qm-section-icon qm-section-icon--green">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div>
          <h2 class="qm-section-title">Clinical Notes</h2>
          <p class="qm-section-desc">Record diagnosis, observations, and recommendations</p>
        </div>
      </div>
    </div>
    <div class="qm-section-body">
      <textarea class="qm-textarea" rows="6"
        placeholder="Enter detailed consultation notes here...&#10;Include:&#10;- Chief complaint&#10;- Examination findings&#10;- Diagnosis&#10;- Recommendations"
        formControlName="notes"></textarea>
      <div *ngIf="consultationForm.get('notes')?.touched && consultationForm.get('notes')?.invalid"
        class="qm-field-error">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span *ngIf="consultationForm.get('notes')?.errors?.['required']">Clinical notes are required</span>
        <span *ngIf="consultationForm.get('notes')?.errors?.['minlength']">Notes must be at least 10 characters</span>
      </div>
    </div>
  </div>

  <!-- Treatment Plan -->
  <div class="qm-card">
    <div class="qm-section-header">
      <div class="qm-section-left">
        <div class="qm-section-icon qm-section-icon--purple">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
          </svg>
        </div>
        <div>
          <h2 class="qm-section-title">Treatment Plan</h2>
          <p class="qm-section-desc">Add medications, procedures, or therapies</p>
        </div>
      </div>
      <button class="qm-btn-add" type="button" (click)="addTreatment()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Treatment
      </button>
    </div>
    <div class="qm-section-body" formArrayName="treatments">
      <!-- Empty State -->
      <div *ngIf="treatments.length === 0" class="qm-empty">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
        </svg>
        <p>No treatments added yet</p>
        <p class="qm-empty-sub">Click "Add Treatment" to prescribe medications or procedures</p>
      </div>

      <!-- Treatment Cards -->
      <div *ngFor="let treatment of treatments.controls; let i = index" [formGroupName]="i" class="qm-treatment">
        <div class="qm-treatment-header">
          <div class="qm-treatment-header-left">
            <div class="qm-treatment-type-icon" [ngClass]="'qm-type-' + (treatment.value.type || 'medication')">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  [attr.d]="getTreatmentIcon(treatment.value.type)"></path>
              </svg>
            </div>
            <span class="qm-treatment-label">Treatment {{ i + 1 }}</span>
          </div>
          <button class="qm-btn-delete" type="button" (click)="removeTreatment(i)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
        <div class="qm-treatment-grid">
          <div>
            <label class="qm-field-label">Type</label>
            <select class="qm-select" formControlName="type">
              <option *ngFor="let type of treatmentTypes" [value]="type">{{ type }}</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <label class="qm-checkbox-label">
              <input type="checkbox" formControlName="administered" />
              Already administered
            </label>
          </div>
          <div class="qm-full">
            <label class="qm-field-label">Details *</label>
            <input type="text" class="qm-input" placeholder="e.g., Amoxicillin 500mg" formControlName="details" />
            <div *ngIf="treatment.get('details')?.touched && treatment.get('details')?.invalid" class="qm-field-error">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span>Treatment details are required</span>
            </div>
          </div>
          <div class="qm-full">
            <label class="qm-field-label">Instructions</label>
            <textarea class="qm-textarea" rows="2" placeholder="e.g., Take twice daily with food for 7 days"
              formControlName="instructions"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="qm-actions">
    <button class="qm-btn qm-btn-secondary" type="button" (click)="router.navigate(['/doctor/appointments'])">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
      Cancel
    </button>
    <button class="qm-btn qm-btn-primary" type="button" (click)="openModal()" [disabled]="isSubmitting()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      Save Consultation
    </button>
  </div>

</form>

<!-- Confirmation Modal -->
<div class="qm-modal-backdrop" *ngIf="isModalOpen()">
  <div class="qm-modal">
    <div class="qm-modal-header">
      <div class="qm-modal-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div>
        <p class="qm-modal-title">Confirm Consultation</p>
        <p class="qm-modal-subtitle">Review before saving</p>
      </div>
    </div>
    <div class="qm-modal-body">
      <p>Are you sure you want to save this consultation for
        <strong>{{ patient()?.firstName && patient()?.lastName
          ? (patient()?.firstName + ' ' + patient()?.lastName)
          : 'Unknown' }}</strong>?
      </p>

      <!-- Summary of what will be saved -->
      <div class="qm-summary">
        <div class="qm-summary-row">
          <span class="qm-summary-label">Clinical Notes</span>
          <span class="qm-summary-value">{{ consultationForm.value.notes?.length || 0 }} characters</span>
        </div>
        <div class="qm-summary-row">
          <span class="qm-summary-label">Treatments</span>
          <span class="qm-summary-value">{{ treatments.length }} prescribed</span>
        </div>
        <div class="qm-summary-row">
          <span class="qm-summary-label">Appointment</span>
          <span class="qm-summary-value">{{ appointment()?.appointmentDate | date:'mediumDate' }} at {{
            appointment()?.appointmentTime || 'N/A' }}</span>
        </div>
      </div>

      <div class="qm-alert">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd" />
        </svg>
        <div>
          <p class="qm-alert-title">Important</p>
          <p class="qm-alert-text">This will complete the appointment and save all consultation details.</p>
        </div>
      </div>
    </div>
    <div class="qm-modal-footer">
      <button class="qm-btn qm-btn-cancel" type="button" (click)="closeModal()">Cancel</button>
      <button class="qm-btn qm-btn-confirm" type="button" [disabled]="isSubmitting()" (click)="onSubmit()">
        <span *ngIf="isSubmitting()" class="qm-spinner"></span>
        {{ isSubmitting() ? 'Saving...' : 'Confirm & Save' }}
      </button>
    </div>
  </div>
</div>